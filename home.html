<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Ví Flow Premium</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* --- MODERN TECH THEME UI --- */
        :root {
            --primary: #2563EB; /* Royal Blue */
            --primary-dark: #1E40AF;
            --secondary: #0F172A; /* Slate 900 */
            --accent: #3B82F6;
            --bg-body: #F1F5F9;
            --bg-card: #FFFFFF;
            --text-main: #1E293B;
            --text-light: #64748B;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --radius: 12px; /* Vuông vức hơn */
            --sidebar-width: 260px;
            --font-main: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --shadow-card: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        /* --- DARK MODE --- */
        body.dark-theme {
            --bg-body: #020617;
            --bg-card: #0F172A;
            --text-main: #F8FAFC;
            --text-light: #94A3B8;
            --shadow-card: 0 0 0 1px #1E293B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; outline: none !important; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; font-size: 14px; overflow-x: hidden; transition: 0.3s; }
        a { text-decoration: none; color: inherit; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* LAYOUT */
        .app-layout { display: flex; min-height: 100vh; width: 100vw; }
        
        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-card); padding: 30px 20px;
            display: flex; flex-direction: column; position: fixed; height: 100vh; top: 0; left: 0;
            border-right: 1px solid rgba(0,0,0,0.05); z-index: 50; transition: 0.3s;
        }
        .logo { 
            font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px;
            margin-bottom: 40px; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .nav-links { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .nav-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px;
            color: var(--text-light); cursor: pointer; transition: all 0.2s ease; font-weight: 500; font-size: 14px;
        }
        .nav-btn:hover { background: #F1F5F9; color: var(--text-main); }
        .nav-btn.active { background: #EFF6FF; color: var(--primary); font-weight: 600; border-left: 3px solid var(--primary); }
        body.dark-theme .nav-btn:hover { background: #1E293B; color: white; }
        body.dark-theme .nav-btn.active { background: #1E293B; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; margin-left: var(--sidebar-width); padding: 30px;
            max-width: 1600px; width: 100%; transition: 0.3s; min-height: 100vh;
        }
        .view-section { display: none; animation: fadeUp 0.3s ease; padding-bottom: 80px; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* COMMON UI ELEMENTS */
        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow-card); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.03);
            position: relative; overflow: hidden;
        }
        h2 { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        h3 { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        /* Grid System */
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        /* Button & Inputs */
        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 12px 20px; border-radius: 8px; font-weight: 600; width: 100%;
            cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline {
            background: transparent; border: 1px solid #CBD5E1; color: var(--text-main);
            padding: 11px 20px; border-radius: 8px; width: 100%; font-weight: 600; cursor: pointer; font-size: 14px;
        }
        .form-input {
            background: #F8FAFC; border: 1px solid #E2E8F0; color: var(--text-main);
            padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; margin-bottom: 15px; font-size: 14px;
        }
        .form-input:focus { border-color: var(--primary); background: white; }

        /* --- TECH PROFILE UI (NEW) --- */
        .pf-header-card {
            display: flex; align-items: center; gap: 25px; padding: 30px;
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            color: white; border-radius: 16px; position: relative; overflow: hidden;
        }
        .pf-header-card::after {
            content: ''; position: absolute; right: 0; bottom: 0; width: 150px; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNDQwIDMyMCI+PHBhdGggZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjA1KSIgZD0iTTAuOTksMTU5QzAuOTksMTU5LDMzMywxNTksMzMzLDE1OUMzMzMsMTU5LDU1NSwyNTUsNTU1LDI1NUM1NTUsMjU1LDc3NywxNTksNzc3LDE1OUM3NzcsMTU5LDEwMDAsMTU5LDEwMDAsMTU5QzEwMDAsMTU5LDExMTEsNTUsMTExMSw1NUMxMTExLDU1LDEzMzMsMTU5LDEzMzMsMTU5QzEzMzMsMTU5LDE0NDAsMTU5LDE0NDAsMTU5WiI+PC9wYXRoPjwvc3ZnPg==');
            background-size: cover; opacity: 0.3;
        }
        .pf-avatar-box {
            position: relative; width: 100px; height: 100px;
        }
        .pf-avatar {
            width: 100%; height: 100%; border-radius: 12px; object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .pf-edit-icon {
            position: absolute; bottom: -5px; right: -5px; background: var(--primary);
            width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; color: white; border: 2px solid #0F172A;
        }
        .pf-info h2 { font-size: 24px; margin-bottom: 5px; }
        .pf-tags { display: flex; gap: 8px; margin-top: 10px; }
        .pf-tag { 
            font-size: 11px; padding: 4px 10px; border-radius: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px);
        }
        .pf-tag.premium { background: rgba(255, 215, 0, 0.2); color: #FFD700; border-color: rgba(255, 215, 0, 0.4); }

        .pf-stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 24px;
        }
        .pf-stat-card {
            background: var(--bg-card); border: 1px solid rgba(0,0,0,0.05); padding: 15px; border-radius: 12px;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .pf-stat-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .pf-stat-icon {
            width: 40px; height: 40px; border-radius: 8px; background: #EFF6FF; color: var(--primary);
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        
        /* SETTINGS LIST (SQUARED) */
        .setting-group { margin-bottom: 30px; }
        .setting-title { font-size: 13px; text-transform: uppercase; color: var(--text-light); font-weight: 700; margin-bottom: 12px; letter-spacing: 1px; }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--bg-card); border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: -1px; transition: 0.2s; cursor: pointer;
        }
        .setting-item:first-child { border-radius: 12px 12px 0 0; }
        .setting-item:last-child { border-radius: 0 0 12px 12px; margin-bottom: 0; }
        .setting-item:only-child { border-radius: 12px; }
        .setting-item:hover { background: #F8FAFC; z-index: 1; border-color: #CBD5E1; }
        
        .st-left { display: flex; align-items: center; gap: 15px; font-weight: 500; }
        .st-icon { width: 32px; text-align: center; color: var(--text-light); }
        .st-right { display: flex; align-items: center; gap: 10px; color: var(--text-light); font-size: 13px; }

        /* TOGGLE SWITCH */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 4px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 3px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* SECURITY SCANNER UI */
        .sec-scan-box {
            background: #0F172A; color: #00FF94; font-family: var(--font-mono);
            padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px solid #1E293B;
            height: 300px; overflow-y: auto; font-size: 13px;
        }
        .console-line { margin-bottom: 8px; display: flex; gap: 10px; opacity: 0; animation: typeIn 0.3s forwards; }
        .cl-time { color: #64748B; }
        .cl-success { color: #00FF94; }
        .cl-warn { color: #F59E0B; }
        .cl-danger { color: #EF4444; }
        @keyframes typeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* MODAL COMMON */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { 
            background: var(--bg-card); width: 90%; max-width: 480px; border-radius: 16px; 
            padding: 30px; position: relative; transform: scale(0.95); transition: 0.3s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .btn-close-x {
            position: absolute; top: 20px; right: 20px; width: 32px; height: 32px;
            border-radius: 8px; background: #F1F5F9; color: #64748B;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn-close-x:hover { background: #EF4444; color: white; }

        /* ACTIONS ROW */
        .act-btn {
            background: var(--bg-card); padding: 20px 10px; border-radius: var(--radius);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
            cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow-card); border: 1px solid rgba(0,0,0,0.03);
        }
        .act-btn:hover { transform: translateY(-5px); border-color: var(--primary); }
        .act-btn i { font-size: 24px; color: var(--primary); background: #EFF6FF; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .act-btn:hover i { background: var(--primary); color: white; }

        /* TRANS LIST */
        .trans-list-container { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        .trans-list-container::-webkit-scrollbar { width: 4px; }
        .trans-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #F1F5F9; cursor: pointer; transition: 0.2s; }
        .trans-item:hover { background: #F8FAFC; padding-left: 10px; border-radius: 8px; }
        .t-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 16px; flex-shrink: 0; }

        /* PREMIUM PLANS */
        .upgrade-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 600px) { .upgrade-grid { grid-template-columns: 1fr 1fr 1fr; } }
        .plan-card { border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .plan-plus { background: #E0F2FE; color: #0284C7; border-color: #BAE6FD; }
        .plan-pro { background: #DCFCE7; color: #16A34A; border-color: #BBF7D0; }
        .plan-premium { background: linear-gradient(135deg, #FEF9C3 0%, #FEF08A 100%); color: #854D0E; border-color: #FDE047; }

        /* RESPONSIVE */
        .mobile-header, .bottom-nav { display: none; }
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px 20px 100px 20px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .pf-stats-grid { grid-template-columns: 1fr; }
            
            .mobile-header {
                display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
                background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 40; border-bottom: 1px solid #eee;
            }
            .bottom-nav {
                position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee;
                display: flex; justify-content: space-around; padding: 10px; z-index: 100;
            }
            .b-nav-item { border:none; background:none; color: #94A3B8; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
            .b-nav-item i { font-size: 20px; }
            .b-nav-item.active { color: var(--primary); }
        }
    </style>
</head>
<body>

<div id="auth-check-overlay" class="modal-overlay">
    <div class="modal-box" style="text-align:center">
        <i class="fa-solid fa-shield-cat" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>Xác thực 2FA</h2>
        <p style="color: #666; margin-bottom: 20px;">Nhập mã từ ứng dụng Authenticator để tiếp tục.</p>
        <input type="number" id="auth-otp-check" class="form-input" placeholder="000 000" style="text-align:center; font-size:24px; letter-spacing:5px; font-family:var(--font-mono)">
        <button class="btn-primary" onclick="app.verifyLogin2FA()">Xác thực</button>
        <button class="btn-outline" style="margin-top:10px" onclick="app.logout()">Đăng xuất</button>
    </div>
</div>

<div class="app-layout">
    <nav class="sidebar">
        <div class="logo" onclick="app.nav('home')"><i class="fa-solid fa-layer-group"></i> Ví Flow</div>
        <div class="nav-links">
            <div class="nav-btn active" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> Tổng quan</div>
            <div class="nav-btn" onclick="app.nav('wallet')"><i class="fa-solid fa-wallet"></i> Ví của tôi</div>
            <div class="nav-btn" onclick="app.nav('groups')"><i class="fa-solid fa-users"></i> Quỹ Nhóm</div>
            <div class="nav-btn" onclick="app.nav('report')"><i class="fa-solid fa-chart-pie"></i> Báo cáo</div>
            <div class="nav-btn" onclick="app.nav('profile')"><i class="fa-solid fa-user-shield"></i> Hồ sơ & Bảo mật</div>
            <div class="nav-btn" onclick="app.logout()" style="margin-top:auto; color:var(--danger)"><i class="fa-solid fa-power-off"></i> Đăng xuất</div>
        </div>
    </nav>

    <main class="main-content">
        <div class="mobile-header">
            <div class="logo" style="margin:0; font-size: 20px;">Ví Flow</div>
            <i class="fa-solid fa-bell"></i>
        </div>

        <div id="home" class="view-section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div>
                    <h2>Tổng quan</h2>
                    <p style="color:var(--text-light)">Xin chào, <span id="home-name" style="font-weight:600; color:var(--text-main)">User</span></p>
                </div>
                <div class="act-btn" style="width:40px; height:40px; padding:0; border-radius:50%; box-shadow:none; border:1px solid #ddd" onclick="app.toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon" style="font-size:16px; width:auto; height:auto; background:none; color:var(--text-main)"></i></div>
            </div>

            <div class="grid-2">
                <div>
                    <div class="card" style="background: linear-gradient(120deg, #2563eb, #4f46e5); color: white; border:none">
                        <div style="display:flex; justify-content:space-between">
                            <div>
                                <div style="opacity:0.8; font-size:13px; font-weight:500">Tổng tài sản</div>
                                <div style="font-size:36px; font-weight:700; margin:5px 0" id="total-balance">0 đ</div>
                            </div>
                            <i class="fa-brands fa-cc-visa" style="font-size:30px; opacity:0.8"></i>
                        </div>
                        <div style="margin-top:30px; display:flex; gap:10px">
                            <button class="btn-primary" style="background:rgba(255,255,255,0.2); width:auto; padding:8px 20px" onclick="app.openModal('transfer')"><i class="fa-solid fa-paper-plane"></i> Chuyển</button>
                            <button class="btn-primary" style="background:rgba(255,255,255,0.2); width:auto; padding:8px 20px" onclick="app.openModal('add_trans')"><i class="fa-solid fa-plus"></i> Thêm GD</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <h3>Giao dịch gần đây</h3>
                            <div style="position:relative; width: 200px;">
                                <i class="fa-solid fa-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#94A3B8; font-size:12px"></i>
                                <input type="text" id="search-trans" class="form-input" placeholder="Tìm kiếm..." style="margin-bottom:0; padding:8px 10px 8px 30px; font-size:13px; height:36px" onkeyup="app.filterTransactions()">
                            </div>
                        </div>
                        <div id="recent-list" class="trans-list-container">
                            </div>
                    </div>
                </div>
                
                <div>
                    <div class="card" style="background: #111; color: #FFD700; border:1px solid #333; cursor:pointer; padding:20px" onclick="app.openModal('upgrade')">
                        <div style="display:flex; align-items:center; gap:15px">
                            <div style="width:40px; height:40px; background:rgba(255,215,0,0.2); border-radius:8px; display:flex; align-items:center; justify-content:center"><i class="fa-solid fa-crown"></i></div>
                            <div>
                                <div style="font-weight:700">Nâng cấp Premium</div>
                                <div style="font-size:12px; opacity:0.7; color:white">Mở khóa giới hạn & tính năng VIP</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Tiện ích</h3>
                        <div class="grid-2" style="gap:10px">
                            <div class="act-btn" onclick="app.nav('groups')"><i class="fa-solid fa-users"></i><span>Nhóm</span></div>
                            <div class="act-btn" onclick="app.runSecurityCheck()"><i class="fa-solid fa-shield-halved"></i><span>Bảo mật</span></div>
                            <div class="act-btn" onclick="app.showMyQR()"><i class="fa-solid fa-qrcode"></i><span>QR</span></div>
                            <div class="act-btn" onclick="document.getElementById('bill-scan-inp').click()"><i class="fa-solid fa-camera"></i><span>Bill</span></div>
                            <input type="file" id="bill-scan-inp" hidden accept="image/*" onchange="app.processBill(this)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile" class="view-section">
            <div class="pf-header-card">
                <div class="pf-avatar-box">
                    <img src="" id="pf-avatar" class="pf-avatar">
                    <div class="pf-edit-icon" onclick="document.getElementById('avatar-inp').click()"><i class="fa-solid fa-pen"></i></div>
                    <input type="file" id="avatar-inp" hidden accept="image/*" onchange="app.updateAvatar(this)">
                </div>
                <div class="pf-info">
                    <h2 id="pf-name">...</h2>
                    <div style="font-size:13px; opacity:0.8" id="pf-email">...</div>
                    <div class="pf-tags">
                        <div class="pf-tag" style="color:var(--success); border-color:var(--success)">VERIFIED</div>
                        <div class="pf-tag premium" id="rank-badge">FREE PLAN</div>
                    </div>
                </div>
            </div>

            <div class="pf-stats-grid">
                <div class="pf-stat-card" onclick="app.nav('wallet')">
                    <div class="pf-stat-icon"><i class="fa-solid fa-wallet"></i></div>
                    <div><div style="font-size:12px; color:var(--text-light)">Ví liên kết</div><div style="font-weight:700">2</div></div>
                </div>
                <div class="pf-stat-card" onclick="app.runSecurityCheck()">
                    <div class="pf-stat-icon" style="color:var(--success); background:#DCFCE7"><i class="fa-solid fa-shield-check"></i></div>
                    <div><div style="font-size:12px; color:var(--text-light)">Điểm tin cậy</div><div style="font-weight:700" id="trust-score-mini">--/100</div></div>
                </div>
                <div class="pf-stat-card" onclick="app.nav('groups')">
                    <div class="pf-stat-icon" style="color:#8B5CF6; background:#F3E8FF"><i class="fa-solid fa-users"></i></div>
                    <div><div style="font-size:12px; color:var(--text-light)">Nhóm tham gia</div><div style="font-weight:700">1</div></div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px;">
                <div>
                    <div class="setting-group">
                        <div class="setting-title">Tài khoản & Bảo mật</div>
                        <div class="setting-item" onclick="app.setup2FA()">
                            <div class="st-left"><div class="st-icon"><i class="fa-solid fa-key"></i></div> Xác thực 2 lớp (2FA)</div>
                            <div class="st-right" id="2fa-status-text">Đang tắt <i class="fa-solid fa-chevron-right"></i></div>
                        </div>
                        <div class="setting-item" onclick="app.openSetupFaceID()">
                            <div class="st-left"><div class="st-icon"><i class="fa-solid fa-face-smile"></i></div> Đăng nhập FaceID</div>
                            <div class="st-right"><span class="status-badge" style="background:#F1F5F9; color:#64748B">Thiết lập</span></div>
                        </div>
                        <div class="setting-item" onclick="app.sendPasswordReset()">
                            <div class="st-left"><div class="st-icon"><i class="fa-solid fa-lock"></i></div> Đổi mật khẩu</div>
                            <div class="st-right"><i class="fa-solid fa-chevron-right"></i></div>
                        </div>
                        <div class="setting-item">
                            <div class="st-left"><div class="st-icon"><i class="fa-solid fa-bell"></i></div> Thông báo qua Email</div>
                            <div class="st-right">
                                <label class="switch">
                                    <input type="checkbox" id="toggle-mail-notif" onchange="app.toggleEmailNotif(this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-group">
                        <div class="setting-title">Thiết bị đăng nhập</div>
                        <div class="card" style="padding:0; border:1px solid rgba(0,0,0,0.05)">
                            <div id="device-list" style="padding:10px"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card" style="background:#0F172A; color:white; border:1px solid #334155">
                        <h3><i class="fa-solid fa-user-shield" style="color:var(--success)"></i> Security Audit</h3>
                        <p style="font-size:13px; color:#94A3B8; margin-bottom:15px">Quét toàn bộ thiết lập bảo mật và phát hiện đăng nhập lạ.</p>
                        <button class="btn-primary" style="background:var(--success); color:#022C22" onclick="app.runSecurityCheck()">Quét Ngay</button>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-title">Hỗ trợ</div>
                        <div class="setting-item" onclick="window.location.href='hotro.html'">
                            <div class="st-left"><div class="st-icon"><i class="fa-solid fa-headset"></i></div> Gửi Ticket</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="wallet" class="view-section"><h2>Ví của tôi</h2><div id="wallet-list"></div></div>
        <div id="groups" class="view-section"><h2>Quỹ nhóm</h2><div id="no-group"></div><div id="group-dashboard"></div></div>
        <div id="report" class="view-section"><h2>Báo cáo</h2></div>

    </main>

    <nav class="bottom-nav">
        <div class="b-nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-house"></i></div>
        <div class="b-nav-item" onclick="app.nav('wallet')"><i class="fa-solid fa-wallet"></i></div>
        <div class="b-nav-item" onclick="app.openModal('transfer')"><div style="background:var(--primary); color:white; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-top:-10px; box-shadow:0 5px 15px rgba(37,99,235,0.3)"><i class="fa-solid fa-plus"></i></div></div>
        <div class="b-nav-item" onclick="app.nav('groups')"><i class="fa-solid fa-users"></i></div>
        <div class="b-nav-item" onclick="app.nav('profile')"><i class="fa-solid fa-user"></i></div>
    </nav>
</div>

<div class="modal-overlay" id="modal-create_group" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box" style="text-align: left; max-width: 400px; padding: 30px;">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <div style="background:#EFF6FF; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border-radius:12px; color:var(--primary); margin-bottom:20px"><i class="fa-solid fa-users-viewfinder" style="font-size:24px"></i></div>
        <h3 style="font-size:20px; margin-bottom: 5px;">Tạo nhóm mới</h3>
        <p style="color:#64748B; font-size:14px; margin-bottom:25px">Quản lý chi tiêu chung với bạn bè & gia đình.</p>
        
        <label style="font-weight:600; font-size:13px; margin-bottom:8px; display:block">Tên nhóm</label>
        <input type="text" id="group-name-inp" class="form-input" placeholder="Ví dụ: Tiền trọ, Du lịch..." style="font-weight:500;">
        
        <button class="btn-primary" onclick="app.createGroup()">Tạo ngay</button>
    </div>
</div>

<div class="modal-overlay" id="modal-security_check" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box" style="background: #020617; border: 1px solid #1E293B; max-width: 550px;">
        <div class="btn-close-x" style="background:#1E293B; color:white" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3 style="color:white; font-family:var(--font-mono)"><i class="fa-solid fa-terminal" style="color:var(--success)"></i> SYSTEM_DIAGNOSTIC</h3>
        <div class="sec-scan-box" id="sec-console">
            </div>
        <div id="sec-result-action" style="display:none; margin-top:15px; text-align:right">
            <button class="btn-primary" style="width:auto" onclick="app.closeModal()">Đóng</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-upgrade" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box" style="max-width: 500px;">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Nâng cấp tài khoản</h3>
        <div id="upgrade-step-1" class="upgrade-grid" style="display:grid; gap:10px">
            <div class="plan-card plan-plus" onclick="app.selectUpgradePlan('Plus', 10000)">
                <div class="plan-badge">Phổ biến</div>
                <div class="plan-name">PLUS</div>
                <div class="plan-price">10.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> Thêm 5 ví liên kết</li>
                    <li><i class="fa-solid fa-check"></i> Báo cáo PDF</li>
                </ul>
            </div>
            <div class="plan-card plan-pro" onclick="app.selectUpgradePlan('Pro', 30000)">
                <div class="plan-name">PRO</div>
                <div class="plan-price">30.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> Mọi tính năng Plus</li>
                    <li><i class="fa-solid fa-check"></i> Không giới hạn nhóm</li>
                </ul>
            </div>
            <div class="plan-card plan-premium" onclick="app.selectUpgradePlan('Premium', 50000)">
                <div class="plan-icon"><i class="fa-solid fa-crown"></i></div>
                <div class="plan-name">PREMIUM</div>
                <div class="plan-price">50.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> <strong>Full tính năng</strong></li>
                    <li><i class="fa-solid fa-check"></i> Hỗ trợ 24/7</li>
                </ul>
            </div>
        </div>
        <div id="upgrade-step-2" style="display:none; text-align:center; animation: fadeUp 0.3s">
            <div style="background: #F8F9FA; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                <p style="font-size:13px; color:#666; margin-bottom:10px">Quét mã để thanh toán:</p>
                <img id="sepay-qr-img" src="" style="width: 200px; border-radius: 10px; border: 1px solid #eee;">
                
                <div style="margin-top:15px; text-align:left; font-size:13px; border-top:1px dashed #ccc; padding-top:10px">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Ngân hàng:</span> <strong id="pay-bank-name">MBBank</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Số tài khoản:</span> <strong id="pay-acc-num">...</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Số tiền:</span> <strong id="pay-amount" style="color:var(--primary)">...</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <span>Nội dung:</span> 
                        <strong id="pay-content" style="background:#FFF3E0; padding:2px 8px; border-radius:4px; color:#E65100; font-family:monospace">...</strong>
                    </div>
                </div>
            </div>
            <button class="btn-outline" onclick="app.backToPlans()">Chọn gói khác</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-transfer" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Chuyển tiền</h3>
        <div class="input-group">
            <input type="text" id="tf-dest" class="form-input" placeholder="Nhập Username hoặc Email" onblur="app.checkUser(this)">
            <div class="input-icon-btn" onclick="app.startScanTransfer()"><i class="fa-solid fa-qrcode"></i></div>
        </div>
        <div id="tf-name" style="color:var(--success); font-weight:600; font-size:14px; margin-bottom:10px; min-height:20px; text-align:left"></div>
        <input type="number" id="tf-amt" class="form-input" placeholder="Số tiền chuyển">
        <input type="text" id="tf-note" class="form-input" placeholder="Lời nhắn">
        <div id="otp-section" style="display:none; border-top:1px dashed #ccc; padding-top:15px; margin-top:10px">
            <p style="font-size:13px; color:#555; text-align:center">Mã OTP xác nhận của bạn:</p>
            <div id="otp-display" style="font-size:24px; letter-spacing:5px; font-weight:bold; color:var(--primary); text-align:center; margin:10px 0; padding:10px; background:#EEF4FF; border-radius:10px; border:1px dashed var(--primary);"></div>
            <input type="number" id="tf-otp-inp" class="form-input" placeholder="Nhập 8 số OTP ở trên">
            <button class="btn-primary" onclick="app.confirmTransfer()">Xác nhận chuyển</button>
        </div>
        <button id="btn-pre-tf" class="btn-primary" onclick="app.preTransfer()">Tiếp tục</button>
    </div>
</div>

<div class="modal-overlay" id="modal-link_bank" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Liên kết Ngân hàng</h3>
        <select id="bank-select" class="form-input">
            <option value="">-- Chọn ngân hàng --</option>
            <optgroup label="Ngân hàng Nhà nước & Big 4">
                <option value="Agribank">Agribank</option>
                <option value="Vietcombank">Vietcombank</option>
                <option value="VietinBank">VietinBank</option>
                <option value="BIDV">BIDV</option>
            </optgroup>
            <optgroup label="Ngân hàng TMCP & Khác">
                <option value="MB Bank">MB Bank</option>
                <option value="Techcombank">Techcombank</option>
                <option value="ACB">ACB</option>
                <option value="VPBank">VPBank</option>
                <option value="TPBank">TPBank</option>
                <option value="MSB">MSB</option>
                <option value="LienVietPostBank">LienVietPostBank</option>
                <option value="VietCapitalBank">VietCapitalBank</option>
                <option value="Sacombank">Sacombank</option>
                <option value="VIB">VIB</option>
                <option value="HDBank">HDBank</option>
                <option value="SeABank">SeABank</option>
                <option value="ShinhanBank">Shinhan Bank</option>
                <option value="BacABank">BacABank</option>
                <option value="ABBANK">ABBANK</option>
                <option value="Eximbank">Eximbank</option>
                <option value="PublicBank">PublicBank</option>
                <option value="OCB">OCB</option>
                <option value="KienLongBank">KienLongBank</option>
                <option value="NamABank">Nam A Bank</option>
                <option value="GPBank">GPBank</option>
                <option value="PVcomBank">PVcomBank</option>
                <option value="NCB">NCB</option>
                <option value="SCB">SCB</option>
                <option value="PGBank">PGBank</option>
                <option value="SaigonBank">SaigonBank</option>
                <option value="DongABank">DongA Bank</option>
                <option value="StandardChartered">Standard Chartered</option>
                <option value="Oceanbank">Oceanbank</option>
                <option value="VRB">VRB</option>
                <option value="VietABank">VietABank</option>
                <option value="VietBank">VietBank</option>
                <option value="IndovinaBank">Indovina Bank</option>
                <option value="BaoVietBank">BaoViet Bank</option>
                <option value="SHB">SHB</option>
                <option value="CBBank">CBBank</option>
                <option value="CIMB">CIMB</option>
                <option value="HSBC">HSBC</option>
                <option value="UOB">UOB</option>
                <option value="Woori">Woori Bank</option>
                <option value="Momo">Ví Momo</option>
                <option value="ZaloPay">ZaloPay</option>
            </optgroup>
        </select>
        <input type="text" id="bank-num" class="form-input" placeholder="Số tài khoản (4 số cuối)"><input type="number" id="bank-bal" class="form-input" placeholder="Số dư ban đầu"><button class="btn-primary" onclick="app.linkBank()">Liên kết ngay</button>
    </div>
</div>

<div class="modal-overlay" id="modal-group_contribute" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Đóng quỹ</h3><input type="number" id="contribute-amt" class="form-input" placeholder="Số tiền"><input type="text" id="contribute-note" class="form-input" placeholder="Ghi chú"><button class="btn-primary" onclick="app.contributeFund()">Xác nhận</button>
    </div>
</div>

<div class="modal-overlay" id="modal-invite_member" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Mời thành viên</h3><input type="email" id="invite-email" class="form-input" placeholder="Email"><button class="btn-primary" onclick="app.inviteMember()">Mời</button>
    </div>
</div>

<div class="modal-overlay" id="modal-add_trans" onclick="if(event.target===this) app.closeModal()">
    <div class="modal-box">
        <div class="btn-close-x" onclick="app.closeModal()"><i class="fa-solid fa-xmark"></i></div>
        <h3>Thêm GD</h3><div style="display:flex;gap:10px;margin-bottom:15px"><button class="btn-primary" style="flex:1;background:#EF476F" onclick="app.setType('exp',this)">Chi tiêu</button><button class="btn-primary" style="flex:1;background:#eee;color:#333" onclick="app.setType('inc',this)">Thu nhập</button></div><input type="number" id="inp-amt" class="form-input" placeholder="Số tiền"><input type="text" id="inp-desc" class="form-input" placeholder="Nội dung"><button class="btn-primary" onclick="app.addTransaction()">Lưu</button>
    </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.app = {
        currentUser: null, userData: null, currentDeviceId: null,
        adminBankInfo: { acc: '0353256543', bank: 'MBBank', bankNameDisplay: 'MB Bank' },

        init() {
            this.loadTheme();
            let dId = localStorage.getItem('flow_device_id');
            if(!dId) { dId = 'dev_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('flow_device_id', dId); }
            this.currentDeviceId = dId;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    this.currentUser = user;
                    const userRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        this.userData = userDoc.data();
                        this.checkNewDeviceLogin(); // Check thiết bị lạ
                        this.renderProfile();
                        this.renderTransactions();
                        
                        const toggle = document.getElementById('toggle-mail-notif');
                        if(toggle) toggle.checked = this.userData.emailNotification || false;
                    }
                } else { window.location.href = 'dangnhap.html'; }
            });
        },

        // --- NEW DEVICE ALERT LOGIC ---
        async checkNewDeviceLogin() {
            const knownDevices = this.userData.devices || [];
            const isKnown = knownDevices.some(d => d.id === this.currentDeviceId);
            
            const devInfo = {
                id: this.currentDeviceId,
                name: navigator.platform || 'Unknown Device',
                agent: navigator.userAgent,
                lastSeen: Date.now()
            };

            if (!isKnown) {
                // Thiết bị lạ -> Gửi email cảnh báo (Giả lập)
                console.warn("New Device Detected!");
                this.sendLoginAlertEmail(devInfo);
                await updateDoc(doc(db, "users", this.currentUser.uid), { devices: arrayUnion(devInfo) });
            }
            this.renderDeviceList(knownDevices.length ? knownDevices : [devInfo]);
        },

        async sendLoginAlertEmail(devInfo) {
            if (!this.userData.emailNotification) return;
            // Thực tế: Gọi Cloud Function gửi mail
            console.log(`[ALERT EMAIL] Gửi cảnh báo đăng nhập lạ tới ${this.userData.email}`);
            this.showToast('Bảo mật', 'Phát hiện thiết bị mới. Đã gửi cảnh báo qua Email.');
        },

        toggleEmailNotif(el) {
            updateDoc(doc(db, "users", this.currentUser.uid), { emailNotification: el.checked })
                .then(() => this.showToast('Cài đặt', el.checked ? 'Đã BẬT thông báo email' : 'Đã TẮT thông báo email'));
        },

        // --- SECURITY SCANNER ---
        runSecurityCheck() {
            this.openModal('security_check');
            const consoleDiv = document.getElementById('sec-console');
            consoleDiv.innerHTML = '';
            
            const logs = [
                { msg: "Initializing security protocols...", type: "normal", delay: 200 },
                { msg: "Checking SSL/TLS encryption...", type: "normal", delay: 600 },
                { msg: `> Protocol: ${window.location.protocol}`, type: "success", delay: 800 },
                { msg: "Verifying user identity...", type: "normal", delay: 1200 },
                { msg: `> Email: ${this.userData.email}`, type: "normal", delay: 1400 },
            ];

            if (this.userData.is2FAEnabled) logs.push({ msg: "> 2FA Status: ACTIVE (Secure)", type: "success", delay: 1800 });
            else logs.push({ msg: "> 2FA Status: INACTIVE (Critical Risk!)", type: "danger", delay: 1800 });

            if (this.userData.phone) logs.push({ msg: "> Recovery Phone: Linked", type: "success", delay: 2200 });
            else logs.push({ msg: "> Recovery Phone: Missing", type: "warn", delay: 2200 });

            logs.push({ msg: "Analyzing login history...", type: "normal", delay: 2800 });
            const devCount = (this.userData.devices || []).length;
            logs.push({ msg: `> Active Sessions: ${devCount}`, type: devCount > 3 ? "warn" : "success", delay: 3000 });

            logs.push({ msg: "Security Audit Completed.", type: "normal", delay: 3500 });

            let totalDelay = 0;
            logs.forEach(log => {
                totalDelay += log.delay || 500;
                setTimeout(() => {
                    const time = new Date().toLocaleTimeString();
                    consoleDiv.innerHTML += `<div class="console-line"><span class="cl-time">[${time}]</span> <span class="cl-${log.type}">${log.msg}</span></div>`;
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                }, totalDelay);
            });

            setTimeout(() => {
                document.getElementById('sec-result-action').style.display = 'block';
                const score = 100 - (this.userData.is2FAEnabled ? 0 : 40) - (this.userData.phone ? 0 : 20);
                document.getElementById('trust-score-mini').innerText = score + '/100';
            }, totalDelay + 500);
        },

        // --- RENDER & UTILS ---
        renderProfile() {
            const d = this.userData;
            document.getElementById('pf-name').innerText = d.name;
            document.getElementById('home-name').innerText = d.name;
            document.getElementById('pf-email').innerText = d.email;
            document.getElementById('pf-avatar').src = d.avatar || `https://ui-avatars.com/api/?name=${d.name}&background=random`;
            document.getElementById('2fa-status-text').innerHTML = d.is2FAEnabled ? '<span style="color:var(--success)">Đang bật</span>' : '<span style="color:var(--danger)">Đang tắt</span> <i class="fa-solid fa-triangle-exclamation"></i>';
        },

        renderDeviceList(devices) {
            const list = document.getElementById('device-list');
            list.innerHTML = '';
            devices.forEach(d => {
                const isCurrent = d.id === this.currentDeviceId;
                list.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <i class="fa-solid fa-mobile-screen" style="color:#64748B"></i>
                            <div>
                                <div style="font-weight:600; font-size:13px">${d.name} ${isCurrent ? '(Máy này)' : ''}</div>
                                <div style="font-size:11px; color:#94A3B8">${new Date(d.lastSeen).toLocaleString()}</div>
                            </div>
                        </div>
                        ${isCurrent ? '<span style="font-size:10px; color:var(--success)">Online</span>' : ''}
                    </div>
                `;
            });
        },

        renderTransactions() {
            document.getElementById('recent-list').innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-size:13px">Đang tải dữ liệu...</div>';
            
            onSnapshot(query(collection(db, "transactions"), where("uid", "==", this.currentUser.uid)), (snap) => { 
                const list = document.getElementById('recent-list'); list.innerHTML=''; 
                const txs = [];
                snap.forEach(d => txs.push(d.data()));
                txs.sort((a,b)=>b.timestamp-a.timestamp); 
                
                this.allTransactions = txs; // Cache for search
                this.renderFilteredTrans(txs);
                
                let total = 0; txs.forEach(t => total += (t.type=='inc' ? t.amount : -t.amount));
                document.getElementById('total-balance').innerText = new Intl.NumberFormat('vi-VN').format(total) + ' đ';
            });
        },

        filterTransactions() {
            const query = document.getElementById('search-trans').value.toLowerCase();
            const filtered = this.allTransactions.filter(t => 
                t.desc.toLowerCase().includes(query) || 
                t.amount.toString().includes(query)
            );
            this.renderFilteredTrans(filtered);
        },

        renderFilteredTrans(txs) {
            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            if(txs.length===0) return list.innerHTML='<div style="text-align:center; padding:20px; color:#999; font-size:13px">Không tìm thấy giao dịch</div>';
            
            txs.forEach(t => {
                const isInc = t.type === 'inc';
                list.innerHTML += `
                <div class="trans-item">
                    <div class="t-icon" style="background:${isInc?'#DCFCE7':'#FEE2E2'}"><i class="fa-solid ${isInc?'fa-arrow-down':'fa-arrow-up'}" style="color:${isInc?'var(--success)':'var(--danger)'}"></i></div>
                    <div style="flex:1">
                        <div style="font-weight:600; font-size:14px">${t.desc}</div>
                        <div style="font-size:11px; color:#94A3B8">${t.date}</div>
                    </div>
                    <div style="font-weight:700; color:${isInc?'var(--success)':'var(--danger)'}">
                        ${isInc?'+':'-'}${new Intl.NumberFormat('vi-VN').format(t.amount)}
                    </div>
                </div>`;
            });
        },

        // --- UPGRADE PREMIUM ---
        selectUpgradePlan(plan, price) {
            const content = `${this.userData.username || 'User'} - ${plan}`;
            const url = `https://qr.sepay.vn/img?acc=${this.adminBankInfo.acc}&bank=${this.adminBankInfo.bank}&amount=${price}&des=${encodeURIComponent(content)}`;
            document.getElementById('sepay-qr-img').src = url;
            document.getElementById('upgrade-step-1').style.display='none';
            document.getElementById('upgrade-step-2').style.display='block';
        },
        backToPlans() {
            document.getElementById('upgrade-step-1').style.display='grid';
            document.getElementById('upgrade-step-2').style.display='none';
        },

        // Basic Navigation & Modal
        nav(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-btn, .b-nav-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); },
        openModal(id) { document.getElementById('modal-'+id).classList.add('open'); },
        closeModal() { document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.remove('open')); },
        logout() { signOut(auth).then(()=>window.location.href='dangnhap.html'); },
        
        // ... (Keep existing logic: FaceID, Transfer, etc.)
        loadTheme() { if(localStorage.getItem('flow_theme') === 'dark') document.body.classList.add('dark-theme'); },
        toggleTheme() { document.body.classList.toggle('dark-theme'); localStorage.setItem('flow_theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light'); },
        showToast(title, msg) { const t = document.getElementById('toast'); document.getElementById('toast-title').innerText=title; document.getElementById('toast-msg').innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
