<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khôi phục mật khẩu - Ví Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #2563EB; 
            --primary-hover: #1d4ed8;
            --text-main: #111827; 
            --text-sub: #6B7280;
            --border: #E5E7EB;
            --bg-surface: #ffffff;
            --error: #EF4444;
            --success: #10B981;
            --success-bg: #ECFDF5;
            --success-border: #A7F3D0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        /* Background Dot Grid đồng bộ */
        body { 
            background-color: #F9FAFB;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
        }

        .auth-container { 
            background: var(--bg-surface);
            width: 100%; 
            max-width: 420px; 
            padding: 48px 40px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            text-align: center; 
        }

        .logo { 
            font-size: 26px; 
            font-weight: 700; 
            color: var(--primary);
            margin-bottom: 8px; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .logo i { font-size: 28px; }

        h2 { color: var(--text-main); margin-bottom: 4px; font-size: 24px; font-weight: 700; }
        p.sub-text { color: var(--text-sub); font-size: 14px; margin-bottom: 32px; line-height: 1.5; }

        .form-group { margin-bottom: 20px; text-align: left; }

        .input-wrapper { position: relative; }
        .input-wrapper i { 
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%); 
            color: #9CA3AF; font-size: 16px; transition: 0.2s;
        }

        input { 
            width: 100%; 
            padding: 14px 40px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-size: 14px; 
            outline: none; 
            color: var(--text-main);
            transition: all 0.2s ease;
            background: #F9FAFB;
        }

        input:focus { 
            background: #fff; border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }
        input:focus + i { color: var(--primary); }

        button { 
            width: 100%; 
            padding: 14px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            font-size: 15px; 
            cursor: pointer; 
            transition: background 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        button:hover { background: var(--primary-hover); }
        button:disabled { background: #9CA3AF; cursor: wait; }

        .link { margin-top: 24px; font-size: 14px; color: var(--text-sub); }
        .link a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .link a:hover { text-decoration: underline; }

        /* Style thông báo Lỗi và Thành công */
        .msg-box { 
            padding: 12px 16px; 
            border-radius: 8px; 
            font-size: 13px; 
            margin-bottom: 20px; 
            display: none; 
            text-align: left;
            line-height: 1.5;
        }

        .error-msg { 
            background: #FEF2F2; 
            color: var(--error); 
            border: 1px solid #FCA5A5;
        }

        .success-msg {
            background: var(--success-bg);
            color: #065F46;
            border: 1px solid var(--success-border);
            align-items: center;
        }
        .success-msg i { color: var(--success); margin-right: 6px; font-size: 16px; }

    </style>
</head>
<body>

    <div class="auth-container">
        <div class="logo"><i class="fa-solid fa-shield-halved"></i> Khôi phục</div>
        <h2>Quên mật khẩu?</h2>
        <p class="sub-text">Nhập email đăng ký của bạn. Chúng tôi sẽ gửi hướng dẫn đặt lại mật khẩu.</p>

        <div id="error-box" class="msg-box error-msg"></div>
        
        <div id="success-box" class="msg-box success-msg">
            <div style="display: flex; align-items: start;">
                <i class="fa-solid fa-circle-check" style="margin-top: 2px;"></i>
                <div>
                    <strong>Đã gửi email!</strong><br>
                    Vui lòng kiểm tra hộp thư đến (và mục Spam) để tạo mật khẩu mới.
                </div>
            </div>
        </div>

        <div id="recovery-form">
            <div class="form-group">
                <div class="input-wrapper">
                    <i class="fa-regular fa-envelope"></i>
                    <input type="email" id="email" placeholder="Nhập địa chỉ email của bạn">
                </div>
            </div>
            <button id="btn-submit">Gửi yêu cầu</button>
        </div>
        
        <div class="link">
            <a href="dangnhap.html" style="color: var(--text-sub); font-weight: 500;">
                <i class="fa-solid fa-arrow-left"></i> Quay lại Đăng nhập
            </a>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const btn = document.getElementById('btn-submit');
        const emailInput = document.getElementById('email');
        const errBox = document.getElementById('error-box');
        const successBox = document.getElementById('success-box');
        const formDiv = document.getElementById('recovery-form');
        const subText = document.querySelector('.sub-text');

        btn.addEventListener('click', async () => {
            const email = emailInput.value.trim();

            // Validate cơ bản
            if(!email) { return showError('Vui lòng nhập email.'); }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) { return showError('Định dạng email không hợp lệ.'); }

            // UI Loading
            btn.innerText = 'Đang kiểm tra...';
            btn.disabled = true;
            errBox.style.display = 'none';

            try {
                // 1. Kiểm tra Email có trong Firestore không
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showError('Email này chưa được đăng ký tài khoản.');
                    resetBtn();
                } else {
                    // 2. Gửi mail reset password
                    await sendPasswordResetEmail(auth, email);
                    
                    // 3. Hiển thị thông báo thành công
                    formDiv.style.display = 'none'; // Ẩn form
                    subText.style.display = 'none'; // Ẩn text hướng dẫn cũ
                    successBox.style.display = 'block'; // Hiện thông báo xanh
                }

            } catch (error) {
                console.error("Lỗi:", error);
                
                let msg = 'Đã có lỗi xảy ra. Vui lòng thử lại.';
                if (error.code === 'auth/user-not-found') msg = 'Email không tồn tại trong hệ thống.';
                if (error.code === 'auth/too-many-requests') msg = 'Bạn gửi yêu cầu quá nhanh. Hãy thử lại sau ít phút.';
                
                showError(msg);
                resetBtn();
            }
        });

        function showError(msg) {
            errBox.innerText = msg;
            errBox.style.display = 'block';
        }

        function resetBtn() {
            btn.disabled = false;
            btn.innerText = 'Gửi yêu cầu';
        }
    </script>
</body>
</html>
