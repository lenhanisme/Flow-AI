<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Ví Flow Premium</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* --- MODERN FINTECH THEME UI --- */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --accent: #8b5cf6;
            --bg-body: #F0F2F5;
            --bg-card: #FFFFFF;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-card: linear-gradient(120deg, #2563eb, #9333ea);
            --radius: 24px;
            --radius-sm: 16px;
            --sidebar-width: 280px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --shadow-glow: 0 20px 25px -5px rgba(59, 130, 246, 0.3);
            --font-main: 'Outfit', sans-serif;
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-theme {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-light: #94a3b8;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 20px 25px -5px rgba(59, 130, 246, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; outline: none !important; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; font-size: 15px; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        a { text-decoration: none; color: inherit; }

        /* DARK MODE FIXES */
        body.dark-theme .form-input { background: #334155; border-color: #475569; color: white; }
        body.dark-theme .form-input::placeholder { color: #64748b; }
        body.dark-theme .nav-btn:hover { background: #334155; color: white; }
        body.dark-theme .nav-btn { color: #cbd5e1; }
        body.dark-theme .nav-btn.active { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        body.dark-theme .pf-bg-header { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); }
        body.dark-theme .pf-quick-actions, body.dark-theme .pf-menu-list, body.dark-theme .pf-promo-row, body.dark-theme .pf-util-card { background: #1e293b; border-color: #334155; }
        body.dark-theme .pf-menu-left, body.dark-theme .pf-q-text, body.dark-theme .pf-util-name { color: #f1f5f9; }
        body.dark-theme .act-btn { background: #1e293b; border-color: #334155; box-shadow: none; }
        body.dark-theme .act-btn span { color: #f1f5f9; }
        body.dark-theme .trans-item:hover { background: #334155; }
        body.dark-theme .card { border: 1px solid #334155; }
        body.dark-theme .mobile-header, body.dark-theme .bottom-nav { background: rgba(30, 41, 59, 0.95); border-color: #334155; }
        body.dark-theme .modal-box { background: #1e293b; color: white; }
        body.dark-theme h3 { color: white; }
        body.dark-theme .profile-info-group { background: #1e293b; border-color: #334155; }
        body.dark-theme .p-row { border-color: #334155; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* LAYOUT */
        .app-layout { display: flex; min-height: 100vh; width: 100vw; }
        
        /* SIDEBAR MODERN */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-card); padding: 40px 25px;
            display: flex; flex-direction: column; position: fixed; height: 100vh; top: 0; left: 0;
            border-right: 1px solid rgba(0,0,0,0.03); z-index: 50; transition: 0.3s;
        }
        .logo { 
            font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
            background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 50px; display: flex; align-items: center; gap: 12px; cursor: pointer; user-select: none;
        }
        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .nav-btn {
            display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-radius: var(--radius-sm);
            color: var(--text-light); cursor: pointer; transition: all 0.3s ease; font-weight: 500; font-size: 15px; user-select: none;
        }
        .nav-btn:hover { background: #f8fafc; color: var(--primary); transform: translateX(5px); }
        .nav-btn.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .nav-btn i { font-size: 20px; width: 24px; text-align: center; transition: 0.3s; }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; margin-left: var(--sidebar-width); padding: 40px;
            max-width: 1600px; width: 100%; transition: 0.3s; min-height: 100vh;
        }
        .view-section { display: none; animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: 100px; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & DASHBOARD */
        .grid-2 { display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 30px; }
        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 30px;
            box-shadow: var(--shadow-md); margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.02);
            position: relative; overflow: hidden; transition: 0.3s;
        }
        h3 { font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; letter-spacing: -0.02em; }

        /* BALANCE CARD - VISA STYLE */
        .balance-card {
            background: var(--gradient-card); color: white;
            padding: 35px; min-height: 220px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--shadow-glow); position: relative; z-index: 1;
            border-radius: var(--radius);
        }
        .balance-card::before, .balance-card::after {
            content: ''; position: absolute; border-radius: 50%; z-index: -1;
        }
        .balance-card::before { width: 300px; height: 300px; background: rgba(255,255,255,0.1); top: -100px; right: -50px; }
        .balance-card::after { width: 200px; height: 200px; background: rgba(255,255,255,0.05); bottom: -50px; left: -50px; }
        
        .balance-label { font-size: 14px; opacity: 0.9; font-weight: 500; }
        .balance-val { font-size: 42px; font-weight: 800; margin: 5px 0 0; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-footer-info { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; }
        .card-chip { width: 40px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 6px; position: relative; overflow: hidden; }
        .card-chip::after { content:''; position: absolute; top:50%; left:0; width:100%; height:1px; background:rgba(255,255,255,0.3); }

        /* ACTIONS ROW */
        .actions-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .act-btn {
            background: var(--bg-card); padding: 20px 10px; border-radius: var(--radius);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-sm); border: 1px solid transparent; user-select: none;
        }
        .act-btn:hover { transform: translateY(-8px); box-shadow: var(--shadow-md); border-color: rgba(59, 130, 246, 0.1); }
        .act-btn i {
            font-size: 24px; color: var(--primary);
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            background: #EFF6FF; border-radius: 18px; transition: 0.3s;
        }
        .act-btn:hover i { background: var(--primary); color: white; }
        .act-btn span { font-size: 13px; font-weight: 600; color: var(--text-main); }

        /* SAVINGS GOAL STYLES */
        .goal-item { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .goal-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .goal-icon { width: 45px; height: 45px; border-radius: 12px; background: #EEF4FF; color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        .goal-info { flex: 1; }
        .goal-progress-bg { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 8px; overflow: hidden; position: relative; }
        .goal-progress-fill { height: 100%; background: var(--gradient); border-radius: 3px; width: 0%; transition: width 0.5s ease; }
        .goal-meta { display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px; color: #888; }

        /* LISTS & ITEMS (IMPROVED FOR SCROLL) */
        .trans-list-container {
            max-height: 350px; /* Chiều cao cố định */
            overflow-y: auto; /* Thanh cuộn dọc */
            padding-right: 5px;
        }
        .trans-list-container::-webkit-scrollbar { width: 4px; }
        .trans-search-bar {
            width: 100%; padding: 10px 15px; border: 1px solid #eee; border-radius: 12px;
            font-size: 13px; margin-bottom: 15px; background: #F9FAFB;
        }
        .trans-item {
            display: flex; align-items: center; padding: 15px 0;
            border-bottom: 1px solid #f1f5f9; transition: 0.2s; cursor: pointer;
        }
        .trans-item:last-child { border-bottom: none; }
        .trans-item:hover { background: #f8fafc; padding-left: 8px; padding-right: 8px; border-radius: 8px; }
        .t-icon {
            width: 42px; height: 42px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 15px; font-size: 16px; flex-shrink: 0;
        }

        /* --- PREMIUM UPGRADE UI --- */
        .upgrade-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 600px) { .upgrade-grid { grid-template-columns: 1fr 1fr 1fr; } }

        .plan-card { border-radius: 16px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; border: 2px solid transparent; position: relative; overflow: hidden; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .plan-plus { background: #E0F2FE; color: #0284C7; border: 1px solid #BAE6FD; }
        .plan-plus:hover { border-color: #0284C7; }

        .plan-pro { background: #DCFCE7; color: #16A34A; border: 1px solid #BBF7D0; }
        .plan-pro:hover { border-color: #16A34A; }

        .plan-premium { background: linear-gradient(135deg, #FEF9C3 0%, #FEF08A 100%); color: #854D0E; border: 1px solid #FDE047; }
        .plan-premium:hover { border-color: #EAB308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }

        .plan-name { font-weight: 800; font-size: 18px; margin-bottom: 5px; text-transform: uppercase; }
        .plan-price { font-size: 20px; font-weight: 700; margin-bottom: 15px; }
        .plan-features { list-style: none; padding: 0; font-size: 12px; opacity: 0.9; text-align: left; margin-left: 10px; }
        .plan-features li { margin-bottom: 5px; }
        .plan-badge { position: absolute; top: 10px; right: 10px; background: white; color: inherit; font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
        .plan-icon { font-size: 24px; margin-bottom: 10px; }

        /* MOBILE & RESPONSIVE */
        .mobile-header { display: none; }
        .bottom-nav { display: none; }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px 20px 100px 20px; width: 100%; }
            .grid-2 { grid-template-columns: 1fr; gap: 20px; }
            .card { padding: 20px; margin-bottom: 20px; }
            .balance-val { font-size: 32px; }
            .actions-row { gap: 12px; margin: 20px 0; }
            .act-btn { padding: 15px 5px; border-radius: 16px; }
            .act-btn i { width: 40px; height: 40px; font-size: 20px; border-radius: 14px; }
            .act-btn span { font-size: 11px; }
            
            /* Mobile Header */
            .mobile-header {
                display: flex; align-items: center; justify-content: space-between;
                padding: 15px 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
                position: sticky; top: 0; z-index: 40; border-bottom: 1px solid #eee; transition: 0.3s;
            }

            /* Modern Floating Bottom Nav */
            .bottom-nav {
                position: fixed; bottom: 20px; left: 20px; right: 20px;
                background: rgba(255,255,255,0.95); backdrop-filter: blur(15px);
                height: 70px; border-radius: 25px;
                display: flex; justify-content: space-around; align-items: center;
                box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5);
                z-index: 100; padding: 0 10px; transition: 0.3s;
            }
            .b-nav-item {
                flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
                background: none; border: none; gap: 4px; color: #94a3b8; transition: 0.3s;
                height: 100%; cursor: pointer; user-select: none;
            }
            .b-nav-item i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
            .b-nav-item.active { color: var(--primary); }
            .b-nav-item.active i { transform: translateY(-3px); }
            .b-nav-middle {
                width: 60px; height: 60px; background: var(--gradient);
                border-radius: 20px; display: flex; align-items: center; justify-content: center;
                color: white; font-size: 24px; transform: translateY(-20px) rotate(45deg);
                box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4); border: 4px solid white; cursor: pointer;
            }
            .b-nav-middle i { transform: rotate(-45deg); }
        }

        /* GENERIC COMPONENTS */
        .btn-primary {
            background: var(--gradient); color: white; border: none;
            padding: 14px 20px; border-radius: 12px; font-weight: 600; width: 100%;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline {
            background: transparent; border: 1px solid #e2e8f0; color: var(--text-main);
            padding: 12px; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer;
        }
        .form-input {
            background: #f8fafc; border: 1px solid #e2e8f0; color: var(--text-main);
            padding: 14px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; margin-bottom: 15px;
        }
        .form-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-group { position: relative; width: 100%; margin-bottom: 15px; }
        .input-group .form-input { margin-bottom: 0; padding-right: 40px; }
        .input-icon-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--primary); font-size: 18px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 90%; max-width: 450px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); padding: 35px; transform: scale(0.9); transition: 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-box { transform: scale(1); }

        /* OTHER STYLES (Kept for compatibility) */
        .bank-card { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 20px; margin-bottom: 0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative; overflow: hidden; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between; transition: 0.3s; }
        .bank-card.add-new { background: white; color: #888; border: 2px dashed #ccc; align-items: center; justify-content: center; cursor: pointer; }
        .bank-logo { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
        .bank-delete { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* PROFILE */
        .pf-bg-header { background: linear-gradient(180deg, #EFF6FF 0%, #F0F2F5 100%); padding: 20px 20px 10px 20px; border-radius: 0 0 30px 30px; margin: -30px -30px 20px -30px; text-align: center; position: relative; }
        .pf-avatar-circle { width: 90px; height: 90px; border-radius: 50%; border: 4px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.08); object-fit: cover; margin-top: 10px; cursor: pointer; }
        .pf-top-actions { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .pf-user-name { font-size: 20px; font-weight: 800; color: #333; margin-top: 10px; }
        .pf-user-phone { font-size: 14px; color: #666; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 5px; margin-bottom: 15px; }
        .pf-badge { background: #06D6A0; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
        .pf-promo-row { display: flex; justify-content: space-between; gap: 10px; background: white; border-radius: 15px; padding: 10px; max-width: 400px; margin: 0 auto; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .pf-promo-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; font-size: 13px; color: #333; cursor: pointer; padding: 5px; border-radius: 10px; }
        .pf-quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); background: white; border-radius: 20px; padding: 20px 10px; margin-bottom: 20px; text-align: center; border: 1px solid #eee; }
        .pf-q-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .pf-q-icon { font-size: 22px; color: #666; }
        .pf-q-text { font-size: 11px; font-weight: 600; color: #333; }
        .pf-section-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 15px; margin-left: 5px; }
        .pf-utilities-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        @media (min-width: 600px) { .pf-utilities-grid { grid-template-columns: repeat(3, 1fr); } }
        .pf-util-card { background: white; padding: 15px; border-radius: 16px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .pf-util-card:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1); }
        .pf-util-icon-box { width: 40px; height: 40px; border-radius: 12px; background: #EEF4FF; color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .pf-util-name { font-weight: 600; font-size: 13px; color: #333; }
        .pf-menu-list { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .pf-menu-item { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .pf-menu-left { display: flex; align-items: center; gap: 15px; font-size: 14px; font-weight: 500; color: #333; }
        .pf-menu-icon { color: #888; width: 20px; text-align: center; }

        /* NEW PROFILE INFO UI */
        .profile-info-group { background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .p-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e2e8f0; }
        .p-row:last-child { border-bottom: none; }
        .p-label { color: var(--text-light); font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .p-val { font-weight: 600; color: var(--text-main); font-size: 14px; text-align: right; }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .status-badge.off { background: #FEE2E2; color: #EF476F; }
        .status-badge.on { background: #DCFCE7; color: #10B981; }

        /* CHART */
        .bar-chart-3-col { display: flex; justify-content: space-around; align-items: flex-end; height: 200px; padding-top: 30px; }
        .b3-col { width: 25%; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; height:100%; }
        .b3-bar { width: 100%; border-radius: 8px 8px 0 0; min-height: 5px; opacity: 0.9; transition: height 0.8s; }
        .b3-val { font-size: 12px; font-weight: 700; margin-bottom: 5px; }
        .b3-label { font-size: 13px; color: #888; margin-top: 10px; font-weight: 600; }
        #chart-bar-inc { background: var(--success); }
        #chart-bar-exp { background: var(--danger); }
        #chart-bar-fund { background: var(--warning); }

        /* SECURITY & OVERLAYS */
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-overlay.active { display: flex; }
        .auth-box { width: 100%; max-width: 400px; text-align: center; }
        
        .toast-notify { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 15px 20px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 15px; z-index: 4000; transition: 0.5s; font-size: 13px; font-weight: 600; border: 1px solid #eee; min-width: 300px; }
        .toast-notify.show { transform: translateX(-50%) translateY(0); }
        .toast-icon { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }

        #transfer-success { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .success-icon { width: 80px; height: 80px; background: #d1fae5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #10b981; margin-bottom: 20px; animation: pop 0.5s ease; }
        @keyframes pop { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* FLOW AI CHAT */
        .flow-ai-fab { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4); cursor: pointer; z-index: 1500; transition: 0.3s; animation: float 3s ease-in-out infinite; }
        .flow-ai-fab:hover { transform: scale(1.1); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .chat-window { position: fixed; bottom: 100px; right: 20px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1500; display: none; flex-direction: column; overflow: hidden; border: 1px solid #eee; }
        .chat-window.open { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-header { background: var(--gradient); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #F8F9FA; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 13px; line-height: 1.4; word-wrap: break-word; }
        .msg-bot { background: white; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-options { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .chat-opt-btn { font-size: 11px; background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .chat-opt-btn:hover { background: var(--primary); color: white; }

        /* SCANNER & FACEID */
        #qr-reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 10px; min-height: 250px; background: #000; }
        #qr-reader video { object-fit: cover; border-radius: 15px; width: 100%; height: 100%; }
        .face-scan-container { position: relative; margin: 0 auto 20px; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; border: 4px dashed #666; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .face-scan-container video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.6; transition: opacity 0.3s; }
        .face-scan-container.face-detected { border: 4px solid var(--primary); box-shadow: 0 0 20px var(--primary); }
        .face-scan-container.face-detected video { opacity: 1; }
        @media (min-width: 901px) { .face-scan-container { width: 480px; height: 360px; border-radius: 20px; } .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--success); box-shadow: 0 0 15px var(--success); animation: scanMove 2s linear infinite; opacity: 0; z-index: 10; } .face-scan-container.face-detected .scan-line { opacity: 1; } @keyframes scanMove { 0% { top:0; opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { top:100%; opacity:0; } } .scan-ring { display: none; } }
        @media (max-width: 900px) { .face-scan-container { width: 260px; height: 260px; border-radius: 50%; } .scan-ring { position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 50%; border: 4px solid transparent; border-top-color: var(--success); border-left-color: var(--success); animation: spin 2s linear infinite; z-index: 10; opacity: 0; } .face-scan-container.face-detected .scan-ring { opacity: 1; } .scan-line { display: none; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } }
        .face-instruction { text-align: center; margin-bottom: 20px; color: #555; font-size: 14px; background: #f0f0f0; padding: 8px 15px; border-radius: 20px; display: inline-block; }
        #faceid-lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }

        /* Popup */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .popup-overlay.active { opacity: 1; pointer-events: auto; }
        .popup-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
        
        .sec-step-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .sec-score-box { text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 15px; }
        .score-circle { width: 80px; height: 80px; border-radius: 50%; background: var(--gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; margin: 0 auto 10px; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
        .recommendation { color: var(--danger); font-size: 13px; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .backup-codes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .backup-code { background: #f0f0f0; padding: 8px; text-align: center; border-radius: 6px; font-family: monospace; letter-spacing: 2px; font-weight: bold; }
    </style>
</head>
<body>

<div id="faceid-lock-screen">
    <div class="face-scan-container" id="face-container-verify">
        <video id="video-verify" autoplay muted playsinline></video>
        <div class="scan-ring"></div>
        <div class="scan-line"></div>
    </div>
    <h2 style="margin-bottom: 10px; margin-top: 15px;">Xác thực FaceID</h2>
    <p id="face-status-text" class="face-instruction">Đang tìm khuôn mặt...</p>
    <button class="btn-outline" style="width:auto; padding: 10px 30px;" onclick="app.logout()">Đăng xuất</button>
</div>

<div id="auth-check-overlay" class="auth-overlay">
    <div class="auth-box">
        <i class="fa-solid fa-shield-cat" style="font-size: 60px; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>Xác thực 2FA</h2>
        <p style="color: #666; margin-bottom: 20px;">Vui lòng nhập mã từ ứng dụng Authenticator để tiếp tục.</p>
        <input type="number" id="auth-otp-check" class="form-input" placeholder="Nhập 6 số..." style="text-align:center; font-size:20px; letter-spacing:5px;">
        <button class="btn-primary" onclick="app.verifyLogin2FA()">Xác thực</button>
        <button class="btn-outline" onclick="app.logout()">Đăng xuất</button>
    </div>
</div>

<div id="toast" class="toast-notify">
    <div class="toast-icon" id="toast-icon" style="background:#06D6A0"><i class="fa-solid fa-check"></i></div>
    <div style="flex:1">
        <div style="font-size:11px; color:#888" id="toast-title">Thông báo</div>
        <div id="toast-msg">Nội dung thông báo</div>
    </div>
</div>

<div id="transfer-success">
    <div class="success-icon"><i class="fa-solid fa-check"></i></div>
    <h2>Chuyển tiền thành công!</h2>
    <h1 style="color:var(--primary); margin: 10px 0" id="success-amount">0 đ</h1>
    <p style="color:#666; margin-bottom:30px">Đã chuyển tới: <strong id="success-receiver">...</strong></p>
    <button class="btn-primary" style="width:200px" onclick="document.getElementById('transfer-success').style.display='none'">Về trang chủ</button>
</div>

<div class="flow-ai-fab" onclick="app.toggleChat()"><i class="fa-solid fa-robot"></i></div>
<div class="chat-window" id="flow-ai-window">
    <div class="chat-header">
        <span><i class="fa-solid fa-robot"></i> FlowAI Support</span>
        <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="app.toggleChat()"></i>
    </div>
    <div class="chat-body" id="chat-messages">
        <div class="chat-msg msg-bot">Xin chào! Tôi là FlowAI. Tôi có thể giúp gì cho bạn?</div>
        <div class="chat-options">
            <div class="chat-opt-btn" onclick="app.askAI('reset_pass')">Quên mật khẩu</div>
            <div class="chat-opt-btn" onclick="app.askAI('transfer')">Cách chuyển tiền</div>
            <div class="chat-opt-btn" onclick="app.askAI('security')">Bảo mật 2FA</div>
            <div class="chat-opt-btn" onclick="app.askAI('contact')">Liên hệ CSKH</div>
        </div>
    </div>
</div>

<div class="app-layout">
    <nav class="sidebar">
        <div class="logo" onclick="window.location.href='home.html'"><i class="fa-solid fa-layer-group"></i> Ví Flow</div>
        <div class="nav-links">
            <div class="nav-btn active" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> Tổng quan</div>
            <div class="nav-btn" onclick="app.nav('wallet')"><i class="fa-solid fa-wallet"></i> Ví của tôi</div>
            <div class="nav-btn" onclick="app.nav('groups')"><i class="fa-solid fa-users"></i> Quỹ Nhóm</div>
            <div class="nav-btn" onclick="app.nav('report')"><i class="fa-solid fa-chart-pie"></i> Báo cáo</div>
            <div class="nav-btn" onclick="app.nav('profile')"><i class="fa-solid fa-user"></i> Hồ sơ</div>
            <div class="nav-btn" onclick="app.logout()" style="margin-top:auto; color:var(--danger)"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</div>
        </div>
    </nav>

    <main class="main-content">
        <div class="mobile-header">
            <div class="logo" style="margin:0; font-size: 20px;" onclick="window.location.href='home.html'">Ví Flow</div>
            <i class="fa-solid fa-right-from-bracket" onclick="app.logout()" style="font-size: 20px; color: var(--danger);"></i>
        </div>

        <div id="home" class="view-section active">
            <div style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="font-size: 24px;">Tổng quan</h2>
                    <div style="color: var(--text-light); font-size: 14px;">Chào mừng trở lại!</div>
                </div>
                <div style="display:flex; gap:10px">
                    <div style="width:40px; height:40px; background:var(--bg-card); border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(0,0,0,0.05); color:var(--text-main)" onclick="app.toggleTheme()">
                        <i class="fa-solid fa-moon" id="theme-icon"></i>
                    </div>
                    <div style="width:40px; height:40px; background:var(--bg-card); border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(0,0,0,0.05); color:var(--text-main)"><i class="fa-regular fa-bell"></i></div>
                </div>
            </div>

            <div class="grid-2">
                <div>
                    <div class="balance-card card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div class="balance-label"><i class="fa-solid fa-wallet"></i> Tổng tài sản</div>
                                <div class="balance-val" id="total-balance">0 đ</div>
                                <div style="font-size: 13px; opacity: 0.8; margin-top: 5px;">**** **** **** 8888</div>
                            </div>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/2560px-Visa_Inc._logo.svg.png" style="height: 20px; opacity: 0.8; filter: brightness(100); mix-blend-mode: overlay;">
                        </div>
                        
                        <div class="card-footer-info">
                            <div style="opacity: 0.9;">
                                <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Chủ thẻ</div>
                                <div style="font-weight: 600; font-size: 16px; margin-top:2px;" id="home-name">...</div>
                            </div>
                            <div class="card-chip"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px; font-weight: 600; font-size: 16px;">Tiện ích nhanh</div>
                    <div class="actions-row">
                        <div class="act-btn" onclick="app.openModal('transfer')">
                            <i class="fa-solid fa-paper-plane"></i>
                            <span>Chuyển tiền</span>
                        </div>
                        <div class="act-btn" onclick="app.openModal('add_trans')">
                            <i class="fa-solid fa-circle-plus"></i>
                            <span>Thêm GD</span>
                        </div>
                        <div class="act-btn" onclick="document.getElementById('bill-scan-inp').click()">
                            <i class="fa-solid fa-qrcode"></i>
                            <span>Quét Bill</span>
                            <input type="file" id="bill-scan-inp" hidden accept="image/*" onchange="app.processBill(this)">
                        </div>
                        <div class="act-btn" onclick="app.nav('groups')">
                            <i class="fa-solid fa-users"></i>
                            <span>Quỹ Nhóm</span>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Giao dịch gần đây</h3>
                            <input type="text" id="search-trans" class="trans-search-bar" placeholder="Tìm theo nội dung, số tiền..." style="width: 200px; margin-bottom:0; padding:8px;" onkeyup="app.filterTransactions()">
                        </div>
                        <div id="recent-list" class="trans-list-container">
                            <div style="text-align:center; color:#999; padding:40px;">
                                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px; color: var(--primary)"></i>
                                <div>Đang tải dữ liệu...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3>Ngân sách tháng</h3>
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; border: 10px solid var(--bg-body); border-top-color: var(--primary); border-left-color: var(--accent); margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <span style="font-size: 24px; font-weight: 700;" id="budget-percent">0%</span>
                                <span style="font-size: 11px; color: #888;">Đã dùng</span>
                            </div>
                        </div>
                        <div style="background: var(--bg-body); padding: 15px; border-radius: 12px; margin-top: 10px;">
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom: 5px;">
                                <span style="color:#666">Tiến độ chi tiêu</span>
                                <span style="font-weight:600; color:var(--primary)">An toàn</span>
                            </div>
                            <div style="height:6px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                                <div id="budget-bar" style="width:0%; height:100%; background:var(--gradient); border-radius:4px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <h3>Mục tiêu</h3>
                            <div style="width:30px; height:30px; background:#EEF4FF; border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary); cursor:pointer" onclick="app.openModal('add_goal')"><i class="fa-solid fa-plus"></i></div>
                        </div>
                        <div id="savings-list">
                            <div style="text-align:center;font-size:12px;color:#999">Chưa có mục tiêu</div>
                        </div>
                    </div>
                    
                    <div class="card" style="background: linear-gradient(135deg, #111 0%, #333 100%); color: white; border:none; cursor: pointer;" onclick="app.openModal('upgrade')">
                        <div style="display:flex; gap:15px; align-items:center;">
                            <div style="width:40px; height:40px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                <i class="fa-solid fa-crown" style="color: #FFD700;"></i>
                            </div>
                            <div>
                                <div style="font-weight:700;">Nâng cấp Premium</div>
                                <div style="font-size:12px; opacity:0.7;">Mở khóa giới hạn chi tiêu</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="groups" class="view-section">
            <div class="group-header" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center">
                <h2>Quỹ Nhóm & Gia Đình</h2>
                <button class="btn-primary" style="width:auto; padding:10px 20px; font-size:13px" onclick="app.openModal('create_group')"><i class="fa-solid fa-plus"></i> Tạo nhóm</button>
            </div>
            <div id="group-dashboard" style="display:none;">
                <div class="balance-card card" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); color:#333; box-shadow: 0 10px 30px rgba(255, 154, 158, 0.4);">
                    <div style="opacity: 0.7; color:white; font-size: 14px;" id="group-name-display">Tên Nhóm</div>
                    <div class="balance-val" id="group-balance" style="color:white">0 đ</div>
                    <div style="margin-top:20px; display:flex; gap:10px">
                        <button style="background:rgba(255,255,255,0.3); border:none; color:white; padding:8px 20px; border-radius:15px; cursor:pointer; font-weight:600" onclick="app.openModal('group_contribute')">
                            <i class="fa-solid fa-circle-dollar-to-slot"></i> Đóng quỹ
                        </button>
                        <button style="background:rgba(255,255,255,0.8); border:none; color:#d63384; padding:8px 20px; border-radius:15px; cursor:pointer; font-weight:600" onclick="app.openSplitBill()">
                            <i class="fa-solid fa-file-invoice-dollar"></i> Chia tiền
                        </button>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <h3>Thành viên (<span id="member-count">0</span>)</h3>
                        <div id="group-members" class="member-list" style="display:flex; flex-direction:column; gap:10px"></div>
                        <button class="btn-outline" style="width:100%; margin-top:15px" onclick="app.openModal('invite_member')">Mời thành viên</button>
                    </div>
                    <div class="card">
                        <h3>Lịch sử đóng góp</h3>
                        <div id="group-history" style="max-height:300px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
            <div id="no-group" class="card" style="text-align:center; padding:50px;">
                <i class="fa-solid fa-users" style="font-size:50px; color:#ddd; margin-bottom:20px;"></i>
                <h3>Bạn chưa tham gia nhóm nào</h3>
                <button class="btn-primary" onclick="app.openModal('create_group')">Tạo nhóm ngay</button>
            </div>
        </div>

        <div id="wallet" class="view-section">
            <h2>Ví & Tài khoản</h2>
            <div id="wallet-list" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top:20px;">
                <div class="bank-card add-new" onclick="app.openModal('link_bank')">
                    <i class="fa-solid fa-plus-circle" style="font-size:40px; margin-bottom:10px;"></i>
                    <div>Liên kết ví mới</div>
                </div>
            </div>
        </div>

        <div id="report" class="view-section">
            <h2>Báo cáo chi tiêu</h2>
            <div class="card" style="margin-top:20px;">
                <h3 style="margin-bottom:15px;">Tổng quan tài chính</h3>
                <div class="bar-chart-3-col">
                    <div class="b3-col">
                        <div class="b3-val" id="val-inc">0đ</div>
                        <div class="b3-bar" id="chart-bar-inc" style="height: 0%;"></div>
                        <div class="b3-label">Thu Nhập</div>
                    </div>
                    <div class="b3-col">
                        <div class="b3-val" id="val-exp">0đ</div>
                        <div class="b3-bar" id="chart-bar-exp" style="height: 0%;"></div>
                        <div class="b3-label">Chi Tiêu</div>
                    </div>
                    <div class="b3-col">
                        <div class="b3-val" id="val-fund">0đ</div>
                        <div class="b3-bar" id="chart-bar-fund" style="height: 0%;"></div>
                        <div class="b3-label">Góp Quỹ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile" class="view-section">
            <div class="pf-bg-header">
                <div class="pf-top-actions" onclick="document.getElementById('avatar-inp').click()">
                    <i class="fa-solid fa-palette"></i> Đổi ảnh nền
                </div>
                <div class="avatar-wrapper" style="margin-bottom:0" onclick="document.getElementById('avatar-inp').click()">
                    <img src="" id="pf-avatar" class="pf-avatar-circle">
                </div>
                <input type="file" id="avatar-inp" hidden accept="image/*" onchange="app.updateAvatar(this)">
                
                <h2 id="pf-name" class="pf-user-name">...</h2>
                <div class="pf-user-phone">
                    <span id="pf-phone-text">...</span>
                    <span class="pf-badge"><i class="fa-solid fa-check"></i> Đã sinh trắc học</span>
                </div>

                <div class="pf-promo-row">
                    <div class="pf-promo-btn" onclick="app.showMyQR()"><i class="fa-solid fa-qrcode" style="color:var(--primary)"></i> Mã nhận tiền</div>
                    <div style="width:1px; background:#eee;"></div>
                    <div class="pf-promo-btn" style="color:#EF476F"><i class="fa-solid fa-gift"></i> Nhận Ngay 250K</div>
                </div>
            </div>

            <div class="pf-quick-actions">
                <div class="pf-q-item" onclick="app.nav('wallet')">
                    <i class="fa-solid fa-wallet pf-q-icon" style="color:#666"></i>
                    <div class="pf-q-text">Quản lý</div>
                </div>
                <div class="pf-q-item" onclick="app.openModal('link_bank')">
                    <i class="fa-solid fa-money-check-dollar pf-q-icon" style="color:#666"></i>
                    <div class="pf-q-text">Thanh toán</div>
                </div>
                <div class="pf-q-item" onclick="app.runSecurityCheck()">
                    <i class="fa-solid fa-shield-halved pf-q-icon" style="color:#666"></i>
                    <div class="pf-q-text">Bảo mật</div>
                </div>
                <div class="pf-q-item" onclick="app.showPopup('info', 'Thông báo', 'Hệ thống thông báo đang được nâng cấp')">
                    <i class="fa-solid fa-bell pf-q-icon" style="color:#666"></i>
                    <div class="pf-q-text">Thông báo</div>
                </div>
             </div>

            <div class="pf-section-title">Tiện ích</div>
            <div class="pf-utilities-grid">
                <div class="pf-util-card" onclick="app.nav('report')">
                    <div class="pf-util-icon-box"><i class="fa-solid fa-chart-pie"></i></div>
                    <div class="pf-util-name">Trung Tâm Tài Chính</div>
                    <div style="font-size:11px; color:#999">Xem báo cáo chi tiêu</div>
                </div>
                <div class="pf-util-card" onclick="app.runSecurityCheck()">
                    <div class="pf-util-icon-box" style="background:#E0F7FA; color:#00BCD4"><i class="fa-solid fa-user-shield"></i></div>
                    <div class="pf-util-name">Điểm Tin Cậy</div>
                    <div style="font-size:11px; color:#999">Bảo vệ tài khoản</div>
                </div>
                <div class="pf-util-card" onclick="app.openSetupFaceID()">
                    <div class="pf-util-icon-box" style="background:#FFF3E0; color:#FF9800"><i class="fa-solid fa-face-smile"></i></div>
                    <div class="pf-util-name">FaceID</div>
                    <div style="font-size:11px; color:#999">Thiết lập khuôn mặt</div>
                </div>
                <div class="pf-util-card" onclick="app.nav('groups')">
                    <div class="pf-util-icon-box" style="background:#F3E5F5; color:#9C27B0"><i class="fa-solid fa-users"></i></div>
                    <div class="pf-util-name">Quỹ Nhóm</div>
                    <div style="font-size:11px; color:#999">Quản lý chi tiêu chung</div>
                </div>
                <div class="pf-util-card" onclick="app.setup2FA()">
                    <div class="pf-util-icon-box" style="background:#E8F5E9; color:#4CAF50"><i class="fa-solid fa-key"></i></div>
                    <div class="pf-util-name">2FA</div>
                    <div style="font-size:11px; color:#999">Xác thực 2 lớp</div>
                </div>
            </div>

            <div class="pf-menu-list">
                <div class="pf-menu-item" onclick="app.toggleChat()">
                    <div class="pf-menu-left"><i class="fa-solid fa-headset pf-menu-icon"></i> Trung tâm trợ giúp</div>
                    <div class="pf-menu-right"><i class="fa-solid fa-angle-right"></i></div>
                </div>
                <div class="pf-menu-item" onclick="app.showPopup('info', 'Thông báo', 'Bạn có thể quản lý cài đặt thông báo trong phần Quick Actions.')">
                    <div class="pf-menu-left"><i class="fa-solid fa-bell pf-menu-icon"></i> Cài đặt thông báo</div>
                    <div class="pf-menu-right"><i class="fa-solid fa-angle-right"></i></div>
                </div>
                <div class="pf-menu-item" onclick="app.showPopup('info', 'Góp ý', 'Cảm ơn bạn đã quan tâm. Tính năng gửi góp ý đang được phát triển.')">
                    <div class="pf-menu-left"><i class="fa-regular fa-envelope pf-menu-icon"></i> Chia sẻ góp ý</div>
                    <div class="pf-menu-right"><i class="fa-solid fa-angle-right"></i></div>
                </div>
                
                <div class="pf-menu-item" onclick="document.getElementById('general-info-expand').style.display = document.getElementById('general-info-expand').style.display=='none'?'block':'none'">
                    <div class="pf-menu-left"><i class="fa-solid fa-circle-info pf-menu-icon"></i> Thông tin chung</div>
                    <div class="pf-menu-right"><i class="fa-solid fa-angle-down"></i></div>
                </div>
                
                <div id="general-info-expand" style="display:none; background:var(--bg-body); padding:20px; border-top:1px solid #eee">
                    
                    <div class="profile-info-group">
                        <div class="p-row">
                            <div class="p-label"><i class="fa-regular fa-user"></i> Username</div>
                            <div class="p-val" id="pf-username">...</div>
                        </div>
                        <div class="p-row">
                            <div class="p-label"><i class="fa-regular fa-envelope"></i> Email</div>
                            <div class="p-val" id="pf-email" style="font-size:13px">...</div>
                        </div>
                        <div class="p-row">
                            <div class="p-label"><i class="fa-regular fa-calendar"></i> Ngày tham gia</div>
                            <div class="p-val" id="pf-joined">...</div>
                        </div>
                        <div class="p-row">
                            <div class="p-label"><i class="fa-solid fa-phone"></i> Số điện thoại</div>
                            <div style="display:flex; align-items:center; gap:10px">
                                <div id="phone-view" class="p-val">...</div>
                                <div id="phone-edit" style="display:none; align-items:center; gap:5px">
                                    <input type="tel" id="pf-phone-input" style="padding:5px; border-radius:8px; border:1px solid #ccc; width:100px; font-size:13px">
                                    <i class="fa-solid fa-check" style="color:var(--success); cursor:pointer" onclick="app.savePhone(this)"></i>
                                    <i class="fa-solid fa-xmark" style="color:var(--danger); cursor:pointer" onclick="app.togglePhoneEdit(false)"></i>
                                </div>
                                <i class="fa-solid fa-pen" style="color:var(--primary); font-size:12px; cursor:pointer" onclick="app.togglePhoneEdit(true)" id="btn-edit-phone"></i>
                            </div>
                        </div>
                    </div>

                    <div class="profile-info-group">
                        <div class="p-row">
                            <div class="p-label"><i class="fa-solid fa-shield-halved"></i> Bảo mật 2 lớp</div>
                            <div id="2fa-status-area">
                                <div id="2fa-off" class="status-badge off"><i class="fa-solid fa-triangle-exclamation"></i> Đang tắt</div>
                                <div id="2fa-on" class="status-badge on" style="display:none"><i class="fa-solid fa-check"></i> Đang bật</div>
                            </div>
                        </div>
                        <div class="p-row" onclick="app.sendPasswordReset()" style="cursor:pointer">
                            <div class="p-label"><i class="fa-solid fa-key"></i> Đổi mật khẩu</div>
                            <div style="font-size:12px; color:var(--primary)"><i class="fa-solid fa-chevron-right"></i></div>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px">
                        <div style="font-size:12px; font-weight:700; color:#888; margin-bottom:10px; text-transform:uppercase">Thiết bị đăng nhập</div>
                        <div id="device-list"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="b-nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-house"></i>Home</button>
        <button class="b-nav-item" onclick="app.nav('wallet')"><i class="fa-solid fa-wallet"></i>Ví</button>
        
        <div class="b-nav-middle" onclick="app.openModal('transfer')">
            <i class="fa-solid fa-plus"></i>
        </div>

        <button class="b-nav-item" onclick="app.nav('groups')"><i class="fa-solid fa-users"></i>Nhóm</button>
        <button class="b-nav-item" onclick="app.nav('profile')"><i class="fa-solid fa-user"></i>Hồ sơ</button>
    </nav>
</div>

<div class="popup-overlay" id="custom-popup">
    <div class="popup-box">
        <div class="popup-icon" id="pop-icon" style="font-size:40px; margin-bottom:15px"></div>
        <div class="popup-title" id="pop-title" style="font-weight:700; font-size:18px; margin-bottom:10px"></div>
        <div class="popup-desc" id="pop-desc" style="color:#666; margin-bottom:20px; font-size:14px"></div>
        <div class="popup-actions"><button class="btn-primary" onclick="app.closePopup()">Đóng</button></div>
    </div>
</div>

<div class="modal-overlay" id="modal-upgrade">
    <div class="modal-box" style="max-width: 500px;">
        <h3>Nâng cấp tài khoản</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px">Chọn gói phù hợp để mở khóa các tính năng giới hạn.</p>
        
        <div id="upgrade-step-1" class="upgrade-grid">
            <div class="plan-card plan-plus" onclick="app.selectUpgradePlan('Plus', 10000)">
                <div class="plan-badge">Phổ biến</div>
                <div class="plan-name">PLUS</div>
                <div class="plan-price">10.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> Thêm 5 ví liên kết</li>
                    <li><i class="fa-solid fa-check"></i> Báo cáo PDF</li>
                </ul>
            </div>

            <div class="plan-card plan-pro" onclick="app.selectUpgradePlan('Pro', 30000)">
                <div class="plan-name">PRO</div>
                <div class="plan-price">30.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> Mọi tính năng Plus</li>
                    <li><i class="fa-solid fa-check"></i> Không giới hạn nhóm</li>
                </ul>
            </div>

            <div class="plan-card plan-premium" onclick="app.selectUpgradePlan('Premium', 50000)">
                <div class="plan-icon"><i class="fa-solid fa-crown"></i></div>
                <div class="plan-name">PREMIUM</div>
                <div class="plan-price">50.000 đ</div>
                <ul class="plan-features">
                    <li><i class="fa-solid fa-check"></i> <strong>Full tính năng</strong></li>
                    <li><i class="fa-solid fa-check"></i> Hỗ trợ 24/7</li>
                </ul>
            </div>
        </div>

        <div id="upgrade-step-2" style="display:none; text-align:center; animation: fadeUp 0.3s">
            <div style="background: #F8F9FA; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                <p style="font-size:13px; color:#666; margin-bottom:10px">Quét mã để thanh toán:</p>
                <img id="sepay-qr-img" src="" style="width: 200px; border-radius: 10px; border: 1px solid #eee;">
                
                <div style="margin-top:15px; text-align:left; font-size:13px; border-top:1px dashed #ccc; padding-top:10px">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Ngân hàng:</span> <strong id="pay-bank-name">MBBank</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Số tài khoản:</span> <strong id="pay-acc-num">...</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span>Số tiền:</span> <strong id="pay-amount" style="color:var(--primary)">...</strong>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <span>Nội dung:</span> 
                        <strong id="pay-content" style="background:#FFF3E0; padding:2px 8px; border-radius:4px; color:#E65100; font-family:monospace">...</strong>
                    </div>
                </div>
            </div>
            
            <p style="font-size:12px; color:#888; margin-bottom:15px">
                <i class="fa-solid fa-circle-info"></i> Sau khi chuyển khoản, vui lòng chụp màn hình và gửi cho Admin để được kích hoạt.
            </p>

            <button class="btn-primary" onclick="app.closeModal()">Đã chuyển khoản</button>
            <button class="btn-outline" style="margin-top:10px" onclick="app.backToPlans()">Chọn gói khác</button>
        </div>

        <button id="btn-close-upgrade" class="btn-outline" style="margin-top:20px" onclick="app.closeModal()">Đóng</button>
    </div>
</div>

<div class="modal-overlay" id="modal-faceid-setup">
    <div class="modal-box" style="text-align:center; max-width: 600px;">
        <h3>Thiết lập FaceID</h3>
        <p class="face-instruction">Giữ khuôn mặt trong khung hình</p>
        <div class="face-scan-container" id="face-container-setup">
            <video id="video-setup" autoplay muted playsinline></video>
            <div class="scan-ring"></div>
            <div class="scan-line"></div>
        </div>
        <button class="btn-primary" id="btn-start-scan" onclick="app.captureFace()">Bắt đầu quét</button>
        <button class="btn-outline" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-setup_2fa">
    <div class="modal-box" style="text-align:center">
        <h3>Thiết lập 2FA</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px">Quét mã QR bên dưới bằng Google Authenticator</p>
        <div id="qrcode" style="display:flex; justify-content:center; margin:15px 0"></div>
        <input type="text" id="2fa-secret-display" class="form-input" readonly style="text-align:center; font-size:12px; background:#f9f9f9" onclick="this.select()">
        <p style="font-size:13px; margin:10px 0">Nhập mã 6 số để xác nhận:</p>
        <input type="number" id="otp-setup-inp" class="form-input" placeholder="XXXXXX" style="text-align:center; letter-spacing:5px; font-weight:bold">
        <button class="btn-primary" onclick="app.confirmEnable2FA()">Kích hoạt</button>
        <button class="btn-outline" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-my-qr">
    <div class="modal-box" style="text-align:center; background:linear-gradient(135deg, #4361EE 0%, #4CC9F0 100%); color:white">
        <h3 style="margin-bottom:5px">Mã Nhận Tiền</h3>
        <p style="font-size:13px; margin-bottom:20px; opacity:0.9">Đưa mã này cho người khác để quét</p>
        <div style="background:white; padding:20px; border-radius:20px; display:inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.2)">
            <div id="my-qr-container"></div>
        </div>
        <div style="margin-top:20px; font-weight:700; font-size:18px" id="my-qr-name"></div>
        <div style="font-size:12px; opacity:0.8" id="my-qr-email"></div>
        <button class="btn-primary" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.5); margin-top:20px" onclick="app.closeModal()">Đóng</button>
    </div>
</div>

<div class="modal-overlay" id="modal-scan-qr">
    <div class="modal-box">
        <h3>Quét Mã Chuyển Tiền</h3>
        <div id="qr-reader"></div>
        <button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeScanner()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-backup_codes">
    <div class="modal-box">
        <h3>Mã dự phòng</h3>
        <p style="font-size:13px; color:#666">Lưu lại các mã này để đăng nhập khi mất điện thoại. Mỗi mã chỉ dùng 1 lần.</p>
        <div id="backup-codes-list" class="backup-codes-grid"></div>
        <button class="btn-primary" style="margin-top:20px" onclick="app.closeModal()">Đóng</button>
    </div>
</div>

<div class="modal-overlay" id="modal-security_check">
    <div class="modal-box">
        <h3><i class="fa-solid fa-user-shield" style="color:var(--primary)"></i> Quét Bảo Mật</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px">Hệ thống đang phân tích dữ liệu thực tế...</p>
        <div class="security-progress" style="background:#eee; height:6px; border-radius:3px; overflow:hidden; margin-bottom:15px">
            <div class="progress-bar" id="sec-check-bar" style="height:100%; background:var(--primary); width:0%; transition: width 0.3s"></div>
        </div>
        <div id="sec-check-list"></div>
        <div id="sec-result" style="display:none" class="sec-score-box">
            <div class="score-circle" id="sec-final-score">0/100</div>
            <div style="font-weight:600; margin-bottom:5px" id="sec-final-text">Đánh giá an toàn</div>
            <div id="sec-recommendations"></div>
            <button class="btn-primary" style="margin-top:15px" onclick="app.closeModal()">Hoàn tất</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-add_goal">
    <div class="modal-box">
        <h3>Tạo Mục Tiêu</h3>
        <input type="text" id="goal-name" class="form-input" placeholder="Tên mục tiêu (VD: Mua xe)">
        <input type="number" id="goal-target" class="form-input" placeholder="Số tiền cần (VD: 50.000.000)">
        <button class="btn-primary" onclick="app.createGoal()">Tạo ngay</button>
        <button class="btn-outline" style="margin-top:10px" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-split_bill">
    <div class="modal-box">
        <h3>Chia tiền hóa đơn</h3>
        <input type="number" id="split-amt" class="form-input" placeholder="Tổng tiền đã chi">
        <input type="text" id="split-note" class="form-input" placeholder="Nội dung (Ăn uống, Grab...)">
        <div id="split-members-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:10px"></div>
        <button class="btn-primary" onclick="app.confirmSplit()">Chia đều & Gửi yêu cầu</button>
        <button class="btn-outline" style="margin-top:10px" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-deposit_goal">
    <div class="modal-box">
        <h3>Nạp tiền vào mục tiêu</h3>
        <div id="deposit-goal-name" style="margin-bottom:10px; font-weight:600"></div>
        <input type="number" id="deposit-amt" class="form-input" placeholder="Số tiền muốn nạp">
        <input type="hidden" id="deposit-goal-id">
        <button class="btn-primary" onclick="app.confirmDepositGoal()">Nạp ngay</button>
        <button class="btn-outline" style="margin-top:10px" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-create_group">
    <div class="modal-box" style="text-align: center;">
        <div style="font-size:40px; color:var(--primary); margin-bottom:15px;"><i class="fa-solid fa-users"></i></div>
        <h3 style="margin-bottom: 20px;">Tạo Nhóm Mới</h3>
        <input type="text" id="group-name-inp" class="form-input" placeholder="Đặt tên nhóm của bạn..." style="text-align:center; font-weight:500;">
        <button class="btn-primary" onclick="app.createGroup()">Tạo nhóm ngay</button>
        <button class="btn-outline" style="margin-top:10px" onclick="app.closeModal()">Để sau</button>
    </div>
</div>

<div class="modal-overlay" id="modal-group_contribute"><div class="modal-box"><h3>Đóng quỹ</h3><input type="number" id="contribute-amt" class="form-input" placeholder="Số tiền"><input type="text" id="contribute-note" class="form-input" placeholder="Ghi chú"><button class="btn-primary" onclick="app.contributeFund()">Xác nhận</button><button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeModal()">Hủy</button></div></div>
<div class="modal-overlay" id="modal-invite_member"><div class="modal-box"><h3>Mời thành viên</h3><input type="email" id="invite-email" class="form-input" placeholder="Email"><button class="btn-primary" onclick="app.inviteMember()">Mời</button><button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeModal()">Hủy</button></div></div>
<div class="modal-overlay" id="modal-add_trans"><div class="modal-box"><h3>Thêm GD</h3><div style="display:flex;gap:10px;margin-bottom:15px"><button class="btn-primary" style="flex:1;background:#EF476F" onclick="app.setType('exp',this)">Chi tiêu</button><button class="btn-primary" style="flex:1;background:#eee;color:#333" onclick="app.setType('inc',this)">Thu nhập</button></div><input type="number" id="inp-amt" class="form-input" placeholder="Số tiền"><input type="text" id="inp-desc" class="form-input" placeholder="Nội dung"><button class="btn-primary" onclick="app.addTransaction()">Lưu</button><button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeModal()">Hủy</button></div></div>

<div class="modal-overlay" id="modal-transfer">
    <div class="modal-box">
        <h3>Chuyển tiền</h3>
        <div class="input-group">
            <input type="text" id="tf-dest" class="form-input" placeholder="Nhập Username hoặc Email" onblur="app.checkUser(this)">
            <div class="input-icon-btn" onclick="app.startScanTransfer()"><i class="fa-solid fa-qrcode"></i></div>
        </div>
        <div id="tf-name" style="color:var(--success); font-weight:600; font-size:14px; margin-bottom:10px; min-height:20px; text-align:left"></div>
        <input type="number" id="tf-amt" class="form-input" placeholder="Số tiền chuyển">
        <input type="text" id="tf-note" class="form-input" placeholder="Lời nhắn">
        <div id="otp-section" style="display:none; border-top:1px dashed #ccc; padding-top:15px; margin-top:10px">
            <p style="font-size:13px; color:#555; text-align:center">Mã OTP xác nhận của bạn:</p>
            <div id="otp-display" style="font-size:24px; letter-spacing:5px; font-weight:bold; color:var(--primary); text-align:center; margin:10px 0; padding:10px; background:#EEF4FF; border-radius:10px; border:1px dashed var(--primary);"></div>
            <input type="number" id="tf-otp-inp" class="form-input" placeholder="Nhập 8 số OTP ở trên">
            <button class="btn-primary" onclick="app.confirmTransfer()">Xác nhận chuyển</button>
        </div>
        <button id="btn-pre-tf" class="btn-primary" onclick="app.preTransfer()">Tiếp tục</button>
        <button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<div class="modal-overlay" id="modal-link_bank">
    <div class="modal-box"><h3>Liên kết Ngân hàng</h3>
        <select id="bank-select" class="form-input">
            <option value="">-- Chọn ngân hàng --</option>
            <optgroup label="Ngân hàng Nhà nước & Big 4">
                <option value="Agribank">Agribank</option>
                <option value="Vietcombank">Vietcombank</option>
                <option value="VietinBank">VietinBank</option>
                <option value="BIDV">BIDV</option>
            </optgroup>
            <optgroup label="Ngân hàng TMCP & Khác">
                <option value="MB Bank">MB Bank</option>
                <option value="Techcombank">Techcombank</option>
                <option value="ACB">ACB</option>
                <option value="VPBank">VPBank</option>
                <option value="TPBank">TPBank</option>
                <option value="MSB">MSB</option>
                <option value="LienVietPostBank">LienVietPostBank</option>
                <option value="VietCapitalBank">VietCapitalBank</option>
                <option value="Sacombank">Sacombank</option>
                <option value="VIB">VIB</option>
                <option value="HDBank">HDBank</option>
                <option value="SeABank">SeABank</option>
                <option value="ShinhanBank">Shinhan Bank</option>
                <option value="BacABank">BacABank</option>
                <option value="ABBANK">ABBANK</option>
                <option value="Eximbank">Eximbank</option>
                <option value="PublicBank">PublicBank</option>
                <option value="OCB">OCB</option>
                <option value="KienLongBank">KienLongBank</option>
                <option value="Momo">Ví Momo</option>
                <option value="ZaloPay">ZaloPay</option>
            </optgroup>
        </select>
        <input type="text" id="bank-num" class="form-input" placeholder="Số tài khoản (4 số cuối)"><input type="number" id="bank-bal" class="form-input" placeholder="Số dư ban đầu"><button class="btn-primary" onclick="app.linkBank()">Liên kết ngay</button><button class="btn-primary" style="background:#eee;color:#333;margin-top:10px" onclick="app.closeModal()">Hủy</button>
    </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, arrayUnion, arrayRemove, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.app = {
        currentUser: null, userData: null, currentGroup: null, groupTransactions: [], tmpType: 'exp',
        transferTarget: null, generatedOTP: null, 
        currentDeviceId: null, temp2FASecret: null,
        report: { inc: 0, exp: 0, fund: 0 }, 
        html5QrcodeScanner: null, 
        allTransactions: [], // Cache all transactions for search

        // --- ADMIN BANK CONFIG ---
        adminBankInfo: {
            acc: '0353256543', 
            bank: 'MBBank', 
            bankNameDisplay: 'MB Bank'
        },

        init() {
            this.loadTheme();
            let dId = localStorage.getItem('flow_device_id');
            if(!dId) { dId = 'dev_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('flow_device_id', dId); }
            this.currentDeviceId = dId;
            
            Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
            ]).then(() => console.log("Face models loaded"));

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    this.currentUser = user;
                    const userRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        this.userData = userDoc.data();
                        
                        if(this.userData.is2FAEnabled) {
                            document.getElementById('auth-check-overlay').classList.add('active');
                        }
                        if(this.userData.faceDescriptor) {
                            this.checkLoginFaceID();
                        }

                        this.renderProfile(); this.renderWallet(); this.listenGroup();
                        this.initDeviceHeartbeat();
                        this.listenUserFund(); 
                        this.listenGoals();
                    }
                    this.listenTransactions();
                } else { window.location.href = 'dangnhap.html'; }
            });
        },

        // --- UPGRADE PREMIUM LOGIC ---
        selectUpgradePlan(planType, amount) {
            const username = this.userData.username || this.userData.name || "User";
            const cleanName = username.replace(/[^a-zA-Z0-9]/g, ''); 
            const content = `${cleanName} - ${planType}`;
            const qrUrl = `https://qr.sepay.vn/img?acc=${this.adminBankInfo.acc}&bank=${this.adminBankInfo.bank}&amount=${amount}&des=${encodeURIComponent(content)}`;

            document.getElementById('sepay-qr-img').src = qrUrl;
            document.getElementById('pay-bank-name').innerText = this.adminBankInfo.bankNameDisplay;
            document.getElementById('pay-acc-num').innerText = this.adminBankInfo.acc;
            document.getElementById('pay-amount').innerText = new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
            document.getElementById('pay-content').innerText = content;

            document.getElementById('upgrade-step-1').style.display = 'none';
            document.getElementById('btn-close-upgrade').style.display = 'none';
            document.getElementById('upgrade-step-2').style.display = 'block';
        },

        backToPlans() {
            document.getElementById('upgrade-step-1').style.display = 'grid';
            document.getElementById('btn-close-upgrade').style.display = 'block';
            document.getElementById('upgrade-step-2').style.display = 'none';
        },

        // --- THEME & UTILS ---
        loadTheme() {
            if(localStorage.getItem('flow_theme') === 'dark') {
                document.body.classList.add('dark-theme');
                const icon = document.getElementById('theme-icon');
                if(icon) { icon.className = 'fa-solid fa-sun'; icon.style.color = '#FDB813'; }
            }
        },
        toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('flow_theme', isDark ? 'dark' : 'light');
            const icon = document.getElementById('theme-icon');
            if(isDark) { icon.className = 'fa-solid fa-sun'; icon.style.color = '#FDB813'; } 
            else { icon.className = 'fa-solid fa-moon'; icon.style.color = '#1f2937'; }
        },
        showPopup(type, title, desc = "") {
            const ol = document.getElementById('custom-popup'), icon = document.getElementById('pop-icon');
            document.getElementById('pop-title').innerText = title; document.getElementById('pop-desc').innerText = desc;
            ol.classList.add('active');
            if(type==='success') icon.innerHTML='<i class="fa-solid fa-circle-check" style="color:var(--success)"></i>';
            else if(type==='error') icon.innerHTML='<i class="fa-solid fa-circle-xmark" style="color:var(--danger)"></i>';
            else icon.innerHTML='<i class="fa-solid fa-circle-info" style="color:var(--primary)"></i>';
        },
        closePopup() { document.getElementById('custom-popup').classList.remove('active'); },
        
        // --- SAVINGS GOALS ---
        async createGoal() {
            const name = document.getElementById('goal-name').value;
            const target = Number(document.getElementById('goal-target').value);
            if(!name || !target) return this.showPopup('error', 'Thiếu thông tin');
            
            try {
                await addDoc(collection(db, "savings_goals"), {
                    uid: this.currentUser.uid,
                    name: name,
                    targetAmount: target,
                    currentAmount: 0,
                    icon: 'fa-bullseye',
                    createdAt: Date.now()
                });
                this.closeModal();
                this.showPopup('success', 'Đã tạo mục tiêu', 'Chúc bạn sớm đạt được!');
                document.getElementById('goal-name').value = '';
                document.getElementById('goal-target').value = '';
            } catch(e) {
                this.showPopup('error', 'Lỗi tạo mục tiêu');
            }
        },
        listenGoals() {
            onSnapshot(query(collection(db, "savings_goals"), where("uid", "==", this.currentUser.uid)), (snap) => {
                const list = document.getElementById('savings-list');
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<div style="text-align:center;font-size:12px;color:#999">Chưa có mục tiêu</div>';
                    return;
                }
                snap.forEach(d => {
                    const g = d.data();
                    const percent = Math.min((g.currentAmount / g.targetAmount) * 100, 100).toFixed(0);
                    list.innerHTML += `
                        <div class="goal-item" onclick="app.openDepositGoal('${d.id}', '${g.name}')">
                            <div class="goal-icon"><i class="fa-solid ${g.icon}"></i></div>
                            <div class="goal-info">
                                <div style="display:flex;justify-content:space-between;font-weight:600;font-size:13px">
                                    <span>${g.name}</span>
                                    <span>${percent}%</span>
                                </div>
                                <div class="goal-progress-bg">
                                    <div class="goal-progress-fill" style="width: ${percent}%"></div>
                                </div>
                                <div class="goal-meta">
                                    <span>${new Intl.NumberFormat('vi-VN').format(g.currentAmount)} đ</span>
                                    <span>Mục tiêu: ${new Intl.NumberFormat('vi-VN').format(g.targetAmount)} đ</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        },
        openDepositGoal(id, name) {
            document.getElementById('deposit-goal-id').value = id;
            document.getElementById('deposit-goal-name').innerText = "Nạp vào: " + name;
            document.getElementById('deposit-amt').value = '';
            this.openModal('deposit_goal');
        },
        async confirmDepositGoal() {
            const id = document.getElementById('deposit-goal-id').value;
            const amt = Number(document.getElementById('deposit-amt').value);
            if(!amt || amt <= 0) return;

            try {
                const goalRef = doc(db, "savings_goals", id);
                const goalSnap = await getDoc(goalRef);
                const current = goalSnap.data().currentAmount || 0;

                await updateDoc(goalRef, { currentAmount: current + amt });

                await addDoc(collection(db, "transactions"), { 
                    uid: this.currentUser.uid, 
                    amount: amt, 
                    desc: `Nạp mục tiêu: ${goalSnap.data().name}`, 
                    type: 'exp', 
                    date: new Date().toLocaleDateString('vi-VN'), 
                    timestamp: Date.now() 
                });

                this.closeModal();
                this.showPopup('success', 'Nạp thành công', 'Cố lên sắp đạt rồi!');
            } catch(e) {
                this.showPopup('error', 'Lỗi xử lý');
            }
        },

        // --- SPLIT BILL ---
        openSplitBill() {
            if(!this.currentGroup) return this.showPopup('error', 'Bạn chưa có nhóm');
            this.openModal('split_bill');
            const list = document.getElementById('split-members-list');
            list.innerHTML = '';
            this.currentGroup.members.forEach(m => {
                list.innerHTML += `
                    <div style="display:flex; align-items:center; margin-bottom:8px;">
                        <input type="checkbox" class="split-check" value="${m.uid}" checked style="width:16px; height:16px; margin-right:10px">
                        <span>${m.name}</span>
                    </div>
                `;
            });
        },
        async confirmSplit() {
            const amt = Number(document.getElementById('split-amt').value);
            const note = document.getElementById('split-note').value;
            const checks = document.querySelectorAll('.split-check:checked');
            
            if(!amt || !note) return this.showPopup('error', 'Thiếu thông tin');
            if(checks.length === 0) return this.showPopup('error', 'Chọn ít nhất 1 người');

            const perPerson = amt / checks.length;
            const names = Array.from(checks).map(c => c.nextElementSibling.innerText).join(', ');

            try {
                await addDoc(collection(db, "group_transactions"), {
                    groupId: this.currentGroup.id,
                    uid: this.currentUser.uid,
                    userName: this.userData.name,
                    amount: 0,
                    note: `CHIA TIỀN: ${note}. Tổng ${new Intl.NumberFormat('vi-VN').format(amt)}. Chia cho: ${names}. Mỗi người: ${new Intl.NumberFormat('vi-VN').format(perPerson)}`,
                    timestamp: Date.now()
                });
                this.closeModal();
                this.showPopup('success', 'Đã tạo yêu cầu chia tiền');
            } catch(e) {
                this.showPopup('error', 'Lỗi');
            }
        },

        // --- FLOW AI ---
        toggleChat() {
            const w = document.getElementById('flow-ai-window');
            if(w.style.display === 'flex') w.style.display = 'none'; else { w.style.display = 'flex'; w.classList.add('open'); }
        },
        askAI(topic) {
            const chat = document.getElementById('chat-messages');
            let q = "", a = "";
            if(topic === 'reset_pass') { q="Quên mật khẩu"; a="Bạn vào Hồ sơ -> Đổi mật khẩu. Nếu không đăng nhập được, hãy bấm 'Quên mật khẩu' ở trang đăng nhập."; }
            if(topic === 'transfer') { q="Cách chuyển tiền"; a="Bấm vào nút 'Chuyển tiền', nhập Username hoặc Email người nhận (hoặc quét QR), nhập số tiền và xác nhận OTP."; }
            if(topic === 'security') { q="Bảo mật 2FA"; a="Vào Hồ sơ -> Bật 2FA. Bạn cần tải app Google Authenticator để quét mã và lấy mã OTP mỗi lần đăng nhập."; }
            if(topic === 'contact') { q="Liên hệ CSKH"; a="Email hỗ trợ: lenhancute1@gmail.com (8h-17h)."; }
            
            chat.innerHTML += `<div class="chat-msg msg-user">${q}</div>`;
            setTimeout(() => { chat.innerHTML += `<div class="chat-msg msg-bot">${a}</div>`; chat.scrollTop = chat.scrollHeight; }, 500);
        },

        // --- NOTIFICATIONS ---
        showToast(title, msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        },

        // --- FACE ID LOGIC ---
        openSetupFaceID() {
            this.openModal('faceid-setup');
            const video = document.getElementById('video-setup');
            navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => { video.srcObject = stream; });
        },
        
        async captureFace() {
            const video = document.getElementById('video-setup');
            const container = document.getElementById('face-container-setup'); 

            container.classList.add('face-detected');

            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            
            if (detection) {
                const descriptorArray = Array.from(detection.descriptor);
                await updateDoc(doc(db, "users", this.currentUser.uid), { faceDescriptor: descriptorArray });
                this.userData.faceDescriptor = descriptorArray;
                
                const stream = video.srcObject;
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
                
                this.closeModal();
                container.classList.remove('face-detected');
                this.showPopup('success', 'FaceID Đã Lưu', 'Bạn có thể đăng nhập bằng khuôn mặt lần sau.');
            } else {
                container.classList.remove('face-detected');
                this.showPopup('error', 'Không tìm thấy khuôn mặt', 'Hãy giữ yên và nhìn thẳng vào cam.');
            }
        },

        async checkLoginFaceID() {
            if (sessionStorage.getItem('isFaceVerified') === 'true') {
                return; 
            }

            const lockScreen = document.getElementById('faceid-lock-screen');
            const statusText = document.getElementById('face-status-text');
            const video = document.getElementById('video-verify');
            const container = document.getElementById('face-container-verify');

            lockScreen.style.display = 'flex';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                
                if(!this.userData.faceDescriptor) {
                    lockScreen.style.display = 'none';
                    return;
                }

                const savedDescriptor = new Float32Array(this.userData.faceDescriptor);
                const faceMatcher = new faceapi.FaceMatcher(savedDescriptor, 0.6); 
                
                const interval = setInterval(async () => {
                    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    
                    if (detection) {
                        container.classList.add('face-detected');
                        statusText.innerText = "Đang xác thực...";
                        statusText.style.color = "var(--primary)";

                        const match = faceMatcher.findBestMatch(detection.descriptor);
                        if (match.distance < 0.45) { 
                            clearInterval(interval);
                            statusText.innerHTML = '<span style="color:var(--success)"><i class="fa-solid fa-check"></i> OK!</span>';
                            container.style.borderColor = 'var(--success)';
                            
                            sessionStorage.setItem('isFaceVerified', 'true');

                            setTimeout(() => {
                                lockScreen.style.display = 'none';
                                stream.getTracks().forEach(track => track.stop());
                            }, 800);
                        }
                    } else {
                        container.classList.remove('face-detected');
                        statusText.innerText = "Di chuyển khuôn mặt vào khung...";
                        statusText.style.color = "#666";
                        container.style.borderColor = '#666';
                    }
                }, 500);
            } catch(e) {
                console.error(e);
                statusText.innerText = "Lỗi Camera. Vui lòng cấp quyền.";
            }
        },

        // --- QR SCANNING & MY QR ---
        showMyQR() {
            this.openModal('my-qr');
            document.getElementById('my-qr-container').innerHTML = '';
            document.getElementById('my-qr-name').innerText = this.userData.name;
            document.getElementById('my-qr-email').innerText = this.userData.email;
            const qrData = `FLOW|${this.currentUser.uid}|${this.userData.email}`;
            new QRCode(document.getElementById("my-qr-container"), { text: qrData, width: 180, height: 180, colorDark : "#4361EE", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        },
        startScanTransfer() {
            this.openModal('scan-qr');
            const html5QrCode = new Html5Qrcode("qr-reader");
            this.html5QrcodeScanner = html5QrCode;
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (decodedText.startsWith('FLOW|')) {
                    const parts = decodedText.split('|'); const targetEmail = parts[2];
                    this.closeScanner();
                    const inp = document.getElementById('tf-dest'); inp.value = targetEmail; this.checkUser(inp);
                    this.showPopup('success', 'Đã quét QR', 'Thông tin người nhận đã được điền.');
                } else { alert("QR không hợp lệ!"); }
            };
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback).catch(err => { console.log("Error starting scanner", err); this.showPopup('error', 'Lỗi Camera', 'Vui lòng cấp quyền camera'); });
        },
        closeScanner() {
            if(this.html5QrcodeScanner) { this.html5QrcodeScanner.stop().then(_ => { this.html5QrcodeScanner.clear(); this.closeModal(); }).catch(error => { console.error("Failed to stop scanner", error); this.closeModal(); }); } else { this.closeModal(); }
        },

        // --- GENERAL LOGIC ---
        initDeviceHeartbeat() { this.sendHeartbeat(); setInterval(() => this.sendHeartbeat(), 10000); },
        async sendHeartbeat() {
            if(!this.currentUser) return;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const devInfo = { id: this.currentDeviceId, name: isMobile ? 'Mobile App (' + (navigator.platform || 'Phone') + ')' : 'PC Web Browser', type: isMobile ? 'mobile' : 'desktop', lastSeen: Date.now() };
            const ref = doc(db, "users", this.currentUser.uid);
            try { const snap = await getDoc(ref); let devices = snap.data().devices || []; devices = devices.filter(d => d.id !== this.currentDeviceId); devices.push(devInfo); await updateDoc(ref, { devices: devices }); this.renderDeviceList(devices); } catch(e) { console.log("HB Error", e); }
        },
        renderDeviceList(devices) {
            const list = document.getElementById('device-list'); list.innerHTML = ''; devices.sort((a,b) => b.lastSeen - a.lastSeen);
            devices.forEach(d => {
                const isOnline = (Date.now() - d.lastSeen) < 20000; const timeStr = isOnline ? 'Đang hoạt động' : new Date(d.lastSeen).toLocaleString('vi-VN'); const icon = d.type === 'mobile' ? 'fa-mobile-screen' : 'fa-laptop'; const statusClass = isOnline ? 'online' : '';
                list.innerHTML += `<div class="device-item"><div style="display:flex;align-items:center"><i class="fa-solid ${icon} device-icon"></i><div><div style="font-weight:600">${d.name} ${d.id===this.currentDeviceId ? '(Máy này)' : ''}</div><div style="color:#888;font-size:11px">Cập nhật: ${timeStr}</div></div></div><div style="display:flex;align-items:center; font-size:11px; font-weight:600; color:${isOnline ? 'var(--success)' : '#999'}"><span class="status-dot ${statusClass}"></span> ${isOnline ? 'Online' : 'Offline'}</div></div>`;
            });
        },
        setup2FA() {
            this.temp2FASecret = new OTPAuth.Secret({ size: 20 });
            const totp = new OTPAuth.TOTP({ issuer: "Ví Flow", label: this.currentUser.email, algorithm: "SHA1", digits: 6, period: 30, secret: this.temp2FASecret });
            this.openModal('setup_2fa');
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: totp.toString(), width: 150, height: 150 });
            document.getElementById('2fa-secret-display').value = this.temp2FASecret.base32;
        },
        async confirmEnable2FA() {
            const token = document.getElementById('otp-setup-inp').value;
            const totp = new OTPAuth.TOTP({ secret: this.temp2FASecret });
            if (totp.validate({ token: token, window: 1 }) !== null) {
                const codes = Array.from({length: 10}, () => Math.random().toString(36).substr(2, 8).toUpperCase());
                await updateDoc(doc(db, "users", this.currentUser.uid), { is2FAEnabled: true, twoFASecret: this.temp2FASecret.base32, backupCodes: codes });
                this.userData.is2FAEnabled = true; this.userData.backupCodes = codes; this.closeModal(); this.renderProfile(); this.showPopup('success', 'Đã bật 2FA thành công!'); this.viewBackupCodes();
            } else { this.showPopup('error', 'Mã xác thực sai'); }
        },
        verifyLogin2FA() {
            const token = document.getElementById('auth-otp-check').value; if(!this.userData.twoFASecret) return;
            const totp = new OTPAuth.TOTP({ secret: OTPAuth.Secret.fromBase32(this.userData.twoFASecret) });
            if (totp.validate({ token: token, window: 1 }) !== null) { document.getElementById('auth-check-overlay').classList.remove('active'); } 
            else { if(this.userData.backupCodes && this.userData.backupCodes.includes(token)) { document.getElementById('auth-check-overlay').classList.remove('active'); alert("Bạn đang dùng mã dự phòng. Hãy tạo mã mới nếu sắp hết."); } else { alert("Mã OTP sai!"); } }
        },
        async disable2FA() { if(confirm("Bạn có chắc muốn tắt 2FA?")) { await updateDoc(doc(db, "users", this.currentUser.uid), { is2FAEnabled: false, twoFASecret: null, backupCodes: null }); this.userData.is2FAEnabled = false; this.renderProfile(); this.showPopup('success', 'Đã tắt 2FA'); } },
        viewBackupCodes() { const list = document.getElementById('backup-codes-list'); list.innerHTML = ''; (this.userData.backupCodes || []).forEach(c => { list.innerHTML += `<div class="backup-code">${c}</div>`; }); this.openModal('backup_codes'); },
        runSecurityCheck() {
            this.openModal('security_check'); const list = document.getElementById('sec-check-list'), bar = document.getElementById('sec-check-bar'), res = document.getElementById('sec-result'), scoreDisplay = document.getElementById('sec-final-score'), recDiv = document.getElementById('sec-recommendations');
            list.innerHTML = ''; bar.style.width = '0%'; list.style.display = 'block'; res.style.display = 'none';
            const checks = [{ name: "Kết nối mã hóa (HTTPS)", icon: "fa-lock", check: () => window.location.protocol === 'https:', msgOk: "An toàn", msgFail: "Không bảo mật" }, { name: "Xác thực Email", icon: "fa-envelope-circle-check", check: () => this.currentUser.emailVerified, msgOk: "Đã xác minh", msgFail: "Chưa xác minh" }, { name: "Số điện thoại bảo vệ", icon: "fa-phone", check: () => (this.userData.phone && this.userData.phone.length > 8), msgOk: "Đã cập nhật", msgFail: "Chưa thêm SĐT" }, { name: "Bảo mật 2 lớp (2FA)", icon: "fa-shield-halved", check: () => this.userData.is2FAEnabled === true, msgOk: "Đang bật", msgFail: "Đang tắt (Nguy hiểm)" }, { name: "Thiết bị đăng nhập", icon: "fa-laptop-medical", check: () => (this.userData.devices || []).length <= 3, msgOk: "Bình thường", msgFail: "Nhiều thiết bị lạ" }];
            let score = 0; let step = 0; let issues = [];
            const runStep = () => {
                if (step >= checks.length) {
                    bar.style.width = '100%'; setTimeout(() => { list.style.display = 'none'; res.style.display = 'block'; let currentScore = 0; const scoreInterval = setInterval(() => { if(currentScore >= score) { currentScore = score; clearInterval(scoreInterval); } scoreDisplay.innerText = currentScore + "/100"; if(currentScore < 50) scoreDisplay.style.background = '#EF476F'; else if(currentScore < 80) scoreDisplay.style.background = '#FFD166'; else scoreDisplay.style.background = 'linear-gradient(135deg, #06D6A0 0%, #11998e 100%)'; currentScore++; }, 20); recDiv.innerHTML = ""; if (issues.length === 0) recDiv.innerHTML = '<div style="color:var(--success)"><i class="fa-solid fa-circle-check"></i> Tài khoản của bạn rất an toàn!</div>'; else issues.forEach(iss => { recDiv.innerHTML += `<div class="recommendation"><i class="fa-solid fa-triangle-exclamation"></i> ${iss}</div>`; }); }, 500); return;
                }
                const item = checks[step]; const isSafe = item.check(); if(isSafe) score += 20; else { if(item.name === "Bảo mật 2 lớp (2FA)") issues.push("Hãy bật 2FA ngay"); if(item.name === "Xác thực Email") issues.push("Hãy xác thực Email"); if(item.name === "Số điện thoại bảo vệ") issues.push("Cập nhật SĐT để khôi phục"); }
                const rowId = `check-step-${step}`; list.innerHTML += `<div class="sec-step-item" id="${rowId}"><div class="sec-step-label"><i class="fa-solid ${item.icon}" style="color:var(--primary)"></i> ${item.name}</div><div class="sec-step-status" style="color:#888"><i class="fa-solid fa-spinner fa-spin"></i> Checking...</div></div>`; bar.style.width = ((step + 1) / checks.length * 100) + '%';
                setTimeout(() => { const statusDiv = document.getElementById(rowId).querySelector('.sec-step-status'); if(isSafe) { statusDiv.innerHTML = `<i class="fa-solid fa-check" style="margin-right:5px"></i> ${item.msgOk}`; statusDiv.style.color = 'var(--success)'; } else { statusDiv.innerHTML = `<i class="fa-solid fa-xmark" style="margin-right:5px"></i> ${item.msgFail}`; statusDiv.style.color = 'var(--danger)'; } step++; runStep(); }, 600);
            };
            runStep();
        },
        renderWallet() { const list = document.getElementById('wallet-list'), btn = list.querySelector('.add-new'); const existingCards = list.querySelectorAll('.bank-card:not(.add-new)'); existingCards.forEach(c => c.remove()); (this.userData.linkedBanks||[]).forEach((b, index) => { const cardHtml = `<div class="bank-card"><div class="bank-delete" onclick="event.stopPropagation(); app.removeBank(${index})"><i class="fa-solid fa-xmark"></i></div><div style="display:flex;justify-content:space-between;"><span class="bank-logo">${b.name}</span><i class="fa-solid fa-wifi"></i></div><div style="font-size:20px;margin:20px 0;letter-spacing:2px">**** ${b.number}</div><div><div style="font-size:12px;opacity:0.8">Số dư</div><div style="font-weight:700;font-size:20px">${new Intl.NumberFormat('vi-VN').format(b.balance)} đ</div></div></div>`; btn.insertAdjacentHTML('beforebegin', cardHtml); }); },
        async removeBank(index) { if(!confirm("Bạn có chắc muốn xóa thẻ này?")) return; const bankToRemove = this.userData.linkedBanks[index]; try { await updateDoc(doc(db, "users", this.currentUser.uid), { linkedBanks: arrayRemove(bankToRemove) }); this.userData.linkedBanks.splice(index, 1); this.renderWallet(); this.showPopup('success', 'Đã xóa thẻ'); } catch(e) { console.error(e); this.showPopup('error', 'Lỗi xóa thẻ'); } },
        async linkBank() { const name = document.getElementById('bank-select').value, num = document.getElementById('bank-num').value, bal = Number(document.getElementById('bank-bal').value); if(!name || !num) return this.showPopup('error', 'Thiếu thông tin'); const newBank = { name, number: num, balance: bal || 0 }; await updateDoc(doc(db, "users", this.currentUser.uid), { linkedBanks: arrayUnion(newBank) }); this.userData.linkedBanks = [...(this.userData.linkedBanks||[]), newBank]; this.renderWallet(); this.closeModal(); this.showPopup('success', 'Liên kết xong'); },
        renderProfile() { const d = this.userData; const blueTick = (d.email === 'lenhancute1@gmail.com') ? '<i class="fa-solid fa-circle-check" style="color:#1DA1F2; margin-left:5px; font-size:16px" title="Đã xác minh"></i>' : ''; document.getElementById('home-name').innerHTML = d.name + blueTick; document.getElementById('pf-name').innerHTML = d.name + blueTick; document.getElementById('pf-username').innerText = d.username || "Chưa set"; document.getElementById('pf-email').innerText = d.email; const ph = document.getElementById('pf-phone-text'); if(d.phone) { document.getElementById('phone-view').innerText=d.phone; ph.innerText=d.phone; ph.style.color='var(--text-main)'; ph.style.fontWeight='600'; } else { document.getElementById('phone-view').innerText="Chưa có SĐT"; ph.innerText="Chưa cập nhật"; ph.style.color='#999'; ph.style.fontWeight='400'; } document.getElementById('pf-joined').innerText = new Date(d.createdAt).toLocaleDateString('vi-VN'); if(d.avatar) document.getElementById('pf-avatar').src = d.avatar; else document.getElementById('pf-avatar').src = `https://ui-avatars.com/api/?name=${d.name}&background=random&size=200`; if(d.is2FAEnabled) { document.getElementById('2fa-off').style.display='none'; document.getElementById('2fa-on').style.display='inline-flex'; } else { document.getElementById('2fa-off').style.display='inline-flex'; document.getElementById('2fa-on').style.display='none'; } },
        listenUserFund() { onSnapshot(query(collection(db, "group_transactions"), where("uid", "==", this.currentUser.uid)), (snap) => { let total = 0; snap.forEach(d => total += d.data().amount); this.report.fund = total; this.updateReportChart(); }); },
        updateReportChart() { const { inc, exp, fund } = this.report; const max = Math.max(inc, exp, fund, 100000); document.getElementById('chart-bar-inc').style.height = (inc / max * 100) + '%'; document.getElementById('val-inc').innerText = new Intl.NumberFormat('vi-VN').format(inc) + 'đ'; document.getElementById('chart-bar-exp').style.height = (exp / max * 100) + '%'; document.getElementById('val-exp').innerText = new Intl.NumberFormat('vi-VN').format(exp) + 'đ'; document.getElementById('chart-bar-fund').style.height = (fund / max * 100) + '%'; document.getElementById('val-fund').innerText = new Intl.NumberFormat('vi-VN').format(fund) + 'đ'; },
        
        listenTransactions() { 
            onSnapshot(query(collection(db, "transactions"), where("uid", "==", this.currentUser.uid)), (snap) => { 
                this.allTransactions = []; // Reset cache
                const list = document.getElementById('recent-list'); list.innerHTML=''; 
                let inc=0, exp=0; 
                snap.forEach(d=>{
                    const t=d.data(); 
                    this.allTransactions.push(t);
                    if(t.type=='inc') inc+=t.amount; else exp+=t.amount;
                }); 
                
                // Sort & Render
                this.allTransactions.sort((a,b)=>b.timestamp-a.timestamp); 
                this.renderTransactions(this.allTransactions);
                
                const bal=inc-exp; const fmt=new Intl.NumberFormat('vi-VN').format; 
                document.getElementById('total-balance').innerText=fmt(bal)+' đ'; 
                document.getElementById('budget-percent').innerText = bal>0 ? Math.min((exp/5000000)*100,100).toFixed(0)+'%' : '0%'; 
                document.getElementById('budget-bar').style.width = document.getElementById('budget-percent').innerText; 
                this.report.inc = inc; this.report.exp = exp; this.updateReportChart(); 
            }); 
        },

        filterTransactions() {
            const query = document.getElementById('search-trans').value.toLowerCase();
            const filtered = this.allTransactions.filter(t => 
                t.desc.toLowerCase().includes(query) || 
                t.amount.toString().includes(query)
            );
            this.renderTransactions(filtered);
        },

        renderTransactions(txs) {
            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            if(txs.length===0) {
                list.innerHTML='<div style="text-align:center;color:#999;padding:20px">Không tìm thấy giao dịch.</div>'; 
                return;
            }
            txs.forEach(t => {
                const isInc = t.type === 'inc';
                const color = isInc ? 'var(--success)' : 'var(--danger)';
                const icon = isInc ? 'fa-arrow-down' : 'fa-arrow-up'; 
                const sign = isInc ? '+' : '-';
                
                list.innerHTML+=`<div class="trans-item"><div class="t-icon" style="background:${isInc?'#DCFCE7':'#FEE2E2'}"><i class="fa-solid ${icon}" style="color:${color}"></i></div><div style="flex:1"><div style="font-weight:600">${t.desc}</div><div style="font-size:12px;color:#888">${t.date}</div></div><div style="font-weight:700;color:${color}">${sign}${new Intl.NumberFormat('vi-VN').format(t.amount)}</div></div>`;
            });
        },

        listenGroup() { if(this.userData.groupId) { document.getElementById('no-group').style.display='none'; document.getElementById('group-dashboard').style.display='block'; onSnapshot(doc(db,"groups",this.userData.groupId),d=>{if(d.exists()){this.currentGroup=d.data();this.currentGroup.id=d.id;this.renderGroupUI()}}); } },
        async createGroup() { const name = document.getElementById('group-name-inp').value; if(!name) return this.showPopup('error', 'Thiếu tên'); try { const ref = await addDoc(collection(db, "groups"), { name, adminId: this.currentUser.uid, balance: 0, members: [{uid:this.currentUser.uid, name:this.userData.name, role:'admin', status:'active'}] }); await updateDoc(doc(db, "users", this.currentUser.uid), { groupId: ref.id }); this.closeModal(); this.showPopup('success', 'Thành công'); setTimeout(()=>location.reload(),1000); } catch(e) { this.showPopup('error', 'Lỗi'); } },
        async inviteMember() { const email = document.getElementById('invite-email').value; const q = query(collection(db, "users"), where("email", "==", email)); const snap = await getDocs(q); if(snap.empty) return this.showPopup('error', 'Không tìm thấy'); const target = snap.docs[0]; if(target.data().groupId) return this.showPopup('error', 'Đã ở nhóm khác'); try { let newMems = [...this.currentGroup.members, {uid:target.id, name:target.data().name, role:'member', status:'active'}]; await updateDoc(doc(db, "groups", this.currentGroup.id), {members: newMems}); await updateDoc(doc(db, "users", target.id), {groupId: this.currentGroup.id}); this.closeModal(); this.showPopup('success', 'Đã mời'); } catch(e) { this.showPopup('error', 'Lỗi'); } },
        async contributeFund() { const amt = Number(document.getElementById('contribute-amt').value), note = document.getElementById('contribute-note').value; if(!amt) return; try { await addDoc(collection(db, "group_transactions"), { groupId: this.currentGroup.id, uid: this.currentUser.uid, userName: this.userData.name, amount: amt, note, timestamp: Date.now() }); await updateDoc(doc(db, "groups", this.currentGroup.id), { balance: (this.currentGroup.balance||0)+amt }); this.closeModal(); this.showPopup('success', 'Đã đóng'); } catch(e) {} },
        renderGroupUI() { document.getElementById('group-name-display').innerText = this.currentGroup.name; document.getElementById('group-balance').innerText = new Intl.NumberFormat('vi-VN').format(this.currentGroup.balance) + ' đ'; document.getElementById('member-count').innerText = this.currentGroup.members.length; const list = document.getElementById('group-members'); list.innerHTML = ''; this.currentGroup.members.forEach(m => { let badge = m.role==='admin' ? '<span class="role-badge role-admin" style="background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:10px;font-size:10px">Admin</span>' : '<span class="role-badge role-member" style="background:#f3f4f6;color:#374151;padding:2px 8px;border-radius:10px;font-size:10px">Member</span>'; list.innerHTML += `<div class="member-item"><div class="member-info" style="display:flex;gap:10px;align-items:center"><img src="https://ui-avatars.com/api/?name=${m.name}&background=random" style="width:30px;height:30px;border-radius:50%"><div><div style="font-weight:600;font-size:13px">${m.name}</div>${badge}</div></div></div>`; }); this.loadGroupHistory(); },
        loadGroupHistory() { onSnapshot(query(collection(db, "group_transactions"), where("groupId", "==", this.currentGroup.id)), (snap) => { const div = document.getElementById('group-history'); div.innerHTML=''; let txs=[]; snap.forEach(d=>txs.push(d.data())); txs.sort((a,b)=>b.timestamp-a.timestamp); this.groupTransactions = txs; txs.forEach(t => div.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;font-size:13px"><div><b>${t.userName}</b><div style="color:#666;font-size:11px">${t.note||'Góp quỹ'}</div></div><div style="color:var(--success)">+${new Intl.NumberFormat('vi-VN').format(t.amount)}</div></div>`); }); },
        togglePhoneEdit(isEdit) { const view = document.getElementById('phone-view'), edit = document.getElementById('phone-edit'), btn = document.getElementById('btn-edit-phone'); if(isEdit) { view.style.display='none'; edit.style.display='flex'; btn.style.display='none'; document.getElementById('pf-phone-input').value=this.userData.phone||""; } else { view.style.display='block'; edit.style.display='none'; btn.style.display='block'; } },
        async savePhone(btn) { const val = document.getElementById('pf-phone-input').value.trim(); if(val && !/^\d{9,11}$/.test(val)) return this.showPopup('error', 'SĐT lỗi'); try { await updateDoc(doc(db, "users", this.currentUser.uid), { phone: val }); this.userData.phone = val; this.renderProfile(); this.togglePhoneEdit(false); this.showPopup('success', 'Đã lưu'); } catch(e){ this.showPopup('error', 'Lỗi'); } },
        async addTransaction() { const amt = Number(document.getElementById('inp-amt').value), desc = document.getElementById('inp-desc').value; if(!amt || !desc) return this.showPopup('error', 'Nhập thiếu'); try { await addDoc(collection(db, "transactions"), { uid: this.currentUser.uid, amount: amt, desc, type: this.tmpType, date: new Date().toLocaleDateString('vi-VN'), timestamp: Date.now() }); this.closeModal(); document.getElementById('inp-amt').value = ''; document.getElementById('inp-desc').value = ''; } catch(e) { this.showPopup('error', 'Lỗi'); } },
        async checkUser(inp) { const val = inp.value.trim(); const nameArea = document.getElementById('tf-name'); this.transferTarget = null; nameArea.innerText = ''; if(!val) return; if(val === this.userData.username || val === this.userData.email) { nameArea.innerText = "Không thể tự chuyển cho chính mình"; return; } let q = query(collection(db, "users"), where("username", "==", val)); let snap = await getDocs(q); if(snap.empty) { q = query(collection(db, "users"), where("email", "==", val)); snap = await getDocs(q); } if(!snap.empty) { const target = snap.docs[0]; this.transferTarget = { id: target.id, ...target.data() }; nameArea.innerText = "Người nhận: " + this.transferTarget.name; } else { nameArea.innerText = "Không tìm thấy người dùng này"; } },
        preTransfer() { const amt = Number(document.getElementById('tf-amt').value); if(!this.transferTarget) return this.showPopup('error', 'Chưa chọn người nhận hợp lệ'); if(!amt || amt <= 0) return this.showPopup('error', 'Số tiền không hợp lệ'); this.generatedOTP = Math.floor(10000000 + Math.random() * 90000000); document.getElementById('otp-section').style.display = 'block'; document.getElementById('otp-display').innerText = this.generatedOTP; document.getElementById('btn-pre-tf').style.display = 'none'; },
        
        async confirmTransfer() { 
            const userOtp = Number(document.getElementById('tf-otp-inp').value); 
            const amt = Number(document.getElementById('tf-amt').value); 
            const note = document.getElementById('tf-note').value || "Chuyển tiền"; 
            if(userOtp !== this.generatedOTP) return this.showPopup('error', 'Sai mã OTP'); 
            
            try { 
                await addDoc(collection(db, "transactions"), { uid: this.currentUser.uid, amount: amt, desc: `Chuyển tới ${this.transferTarget.name}: ${note}`, type: 'exp', date: new Date().toLocaleDateString('vi-VN'), timestamp: Date.now() }); 
                await addDoc(collection(db, "transactions"), { uid: this.transferTarget.id, amount: amt, desc: `Nhận từ ${this.userData.name}: ${note}`, type: 'inc', date: new Date().toLocaleDateString('vi-VN'), timestamp: Date.now() }); 
                
                this.closeModal(); 
                
                // Show Success Screen
                document.getElementById('transfer-success').style.display = 'flex';
                document.getElementById('success-amount').innerText = '-' + new Intl.NumberFormat('vi-VN').format(amt) + ' đ';
                document.getElementById('success-receiver').innerText = this.transferTarget.name;

                // Show Notification
                this.showToast('Biến động số dư', `Tài khoản -${new Intl.NumberFormat('vi-VN').format(amt)} đ. GD: ${this.transferTarget.name}`);

                // Reset Form
                document.getElementById('tf-dest').value = ''; document.getElementById('tf-amt').value = ''; document.getElementById('tf-note').value = ''; document.getElementById('otp-section').style.display = 'none'; document.getElementById('btn-pre-tf').style.display = 'block'; document.getElementById('tf-name').innerText = ''; this.transferTarget = null; 
            } catch(e) { console.error(e); this.showPopup('error', 'Lỗi chuyển tiền'); } 
        },
        
        processBill(input) { const file = input.files[0]; if(!file) return; this.showPopup('info', 'Đang quét Bill...', 'Vui lòng đợi giây lát'); Tesseract.recognize(file, 'vie', { logger: m => console.log(m) }).then(({ data: { text } }) => { this.closePopup(); const numbers = text.match(/\d{1,3}(?:[.,]\d{3})*(?:\.\d+)?/g); let maxAmount = 0; if (numbers) { numbers.forEach(num => { let cleanNum = parseFloat(num.replace(/[.,]/g, '')); if (cleanNum > 1000 && cleanNum < 1000000000) { if(cleanNum > maxAmount) maxAmount = cleanNum; } }); } this.openModal('add_trans'); if(maxAmount > 0) document.getElementById('inp-amt').value = maxAmount; document.getElementById('inp-desc').value = "Quét Bill: " + file.name; this.setType('exp', document.querySelector('#modal-add_trans button')); this.showPopup('success', 'Quét hoàn tất', 'Vui lòng kiểm tra lại số tiền'); }).catch(err => { this.closePopup(); this.showPopup('error', 'Không đọc được Bill'); }); input.value = ''; },
        async updateAvatar(i) { const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=async(e)=>{const b=e.target.result;document.getElementById('pf-avatar').src=b;await updateDoc(doc(db,"users",this.currentUser.uid),{avatar:b});this.showPopup('success','Đã đổi Avatar');};r.readAsDataURL(f); },
        async sendPasswordReset() { 
            console.log("Attempting to send email to:", this.currentUser.email);
            if(confirm("Gửi mail đổi pass?")) { 
                try {
                    await sendPasswordResetEmail(auth, this.currentUser.email); 
                    this.showPopup('success', 'Đã gửi email', 'Vui lòng kiểm tra hộp thư đến (và mục spam).'); 
                } catch(e) {
                    console.error("Firebase Email Error:", e);
                    this.showPopup('error', 'Lỗi gửi email', e.message);
                }
            } 
        },
        logout() { 
            sessionStorage.removeItem('isFaceVerified');
            signOut(auth).then(()=>window.location.href='dangnhap.html'); 
        },
        nav(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-btn, .b-nav-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); },
        openModal(id) { document.getElementById('modal-'+id).classList.add('open'); },
        closeModal() { document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.remove('open')); },
        setType(type, btn) { this.tmpType=type; btn.parentElement.querySelectorAll('button').forEach(b=>{b.style.background='#eee';b.style.color='#333'}); btn.style.background=type==='exp'?'#EF476F':'#06D6A0'; btn.style.color='white'; }
    };
    window.onload = () => app.init();
</script>
</body>
</html>
